

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>importExcelSignals &mdash; DTA Anyway 1.0 documentation</title>
    
    <link rel="stylesheet" href="../_static/dta.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="DTA Anyway 1.0 documentation" href="../index.html" />
    <link rel="up" title="Module code" href="index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../index.html">DTA Anyway 1.0 documentation</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for importExcelSignals</h1><div class="highlight"><pre>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This script reads the SF signal cards (which are in Excel workbooks) and creates corresponding</span>
<span class="sd">:py:class:`dta.TimePlan` instances for them.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">__copyright__</span>   <span class="o">=</span> <span class="s">&quot;Copyright 2011 SFCTA&quot;</span>
<span class="n">__license__</span>     <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span>
<span class="s">    This file is part of DTA.</span>

<span class="s">    DTA is free software: you can redistribute it and/or modify</span>
<span class="s">    it under the terms of the GNU General Public License as published by</span>
<span class="s">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="s">    (at your option) any later version.</span>

<span class="s">    DTA is distributed in the hope that it will be useful,</span>
<span class="s">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="s">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="s">    GNU General Public License for more details.</span>

<span class="s">    You should have received a copy of the GNU General Public License</span>
<span class="s">    along with DTA.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<span class="s">&quot;&quot;&quot;</span>

<span class="c">#import json</span>
<span class="kn">import</span> <span class="nn">pdb</span>

<span class="kn">import</span> <span class="nn">csv</span> 
<span class="kn">import</span> <span class="nn">difflib</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">xlrd</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">izip</span><span class="p">,</span> <span class="n">chain</span>
<span class="kn">import</span> <span class="nn">sys</span> 

<span class="kn">import</span> <span class="nn">datetime</span>

<span class="kn">from</span> <span class="nn">dta.MultiArray</span> <span class="kn">import</span> <span class="n">MultiArray</span>

<span class="kn">import</span> <span class="nn">dta</span>
<span class="kn">from</span> <span class="nn">dta.DynameqScenario</span> <span class="kn">import</span> <span class="n">DynameqScenario</span>
<span class="kn">from</span> <span class="nn">dta.DynameqNetwork</span> <span class="kn">import</span> <span class="n">DynameqNetwork</span>
<span class="kn">from</span> <span class="nn">dta.Algorithms</span> <span class="kn">import</span> <span class="n">pairwise</span><span class="p">,</span> <span class="n">any2</span><span class="p">,</span> <span class="n">all2</span> 
<span class="kn">from</span> <span class="nn">dta.TimePlan</span> <span class="kn">import</span> <span class="n">TimePlan</span><span class="p">,</span> <span class="n">PlanCollectionInfo</span>
<span class="kn">from</span> <span class="nn">dta.Phase</span> <span class="kn">import</span> <span class="n">Phase</span>
<span class="kn">from</span> <span class="nn">dta.PhaseMovement</span> <span class="kn">import</span> <span class="n">PhaseMovement</span>
<span class="kn">from</span> <span class="nn">dta.Utils</span> <span class="kn">import</span> <span class="n">Time</span>

<div class="viewcode-block" id="ExcelCardError"><a class="viewcode-back" href="../script_importExcelSignals.html#importExcelSignals.ExcelCardError">[docs]</a><span class="k">class</span> <span class="nc">ExcelCardError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>
</div>
<div class="viewcode-block" id="MovementMappingError"><a class="viewcode-back" href="../script_importExcelSignals.html#importExcelSignals.MovementMappingError">[docs]</a><span class="k">class</span> <span class="nc">MovementMappingError</span><span class="p">(</span><span class="n">ExcelCardError</span><span class="p">):</span>
    <span class="k">pass</span>
</div>
<div class="viewcode-block" id="SignalConversionError"><a class="viewcode-back" href="../script_importExcelSignals.html#importExcelSignals.SignalConversionError">[docs]</a><span class="k">class</span> <span class="nc">SignalConversionError</span><span class="p">(</span><span class="n">ExcelCardError</span><span class="p">):</span>
    <span class="k">pass</span>
</div>
<div class="viewcode-block" id="ParsingCardError"><a class="viewcode-back" href="../script_importExcelSignals.html#importExcelSignals.ParsingCardError">[docs]</a><span class="k">class</span> <span class="nc">ParsingCardError</span><span class="p">(</span><span class="n">ExcelCardError</span><span class="p">):</span>
    <span class="k">pass</span>
</div>
<div class="viewcode-block" id="ExcelSignalTimingError"><a class="viewcode-back" href="../script_importExcelSignals.html#importExcelSignals.ExcelSignalTimingError">[docs]</a><span class="k">class</span> <span class="nc">ExcelSignalTimingError</span><span class="p">(</span><span class="n">ParsingCardError</span><span class="p">):</span>
    <span class="k">pass</span>
</div>
<div class="viewcode-block" id="StreetNameMappingError"><a class="viewcode-back" href="../script_importExcelSignals.html#importExcelSignals.StreetNameMappingError">[docs]</a><span class="k">class</span> <span class="nc">StreetNameMappingError</span><span class="p">(</span><span class="n">ExcelCardError</span><span class="p">):</span>
    <span class="k">pass</span>

</div>
<span class="n">GREEN</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">YELLOW</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">RED</span> <span class="o">=</span> <span class="mi">2</span>

<span class="n">TURN_LEFT</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;LT&quot;</span><span class="p">,</span> <span class="s">&quot;LT2&quot;</span><span class="p">)</span>
<span class="n">TURN_THRU</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;TH&quot;</span><span class="p">,</span> <span class="s">&quot;TH2&quot;</span><span class="p">)</span>
<span class="n">TURN_RIGHT</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;RT&quot;</span><span class="p">,</span> <span class="s">&quot;RT2&quot;</span><span class="p">)</span>

<span class="c">#: How to use this script</span>
<span class="n">USAGE</span> <span class="o">=</span> <span class="s">r&quot;&quot;&quot;</span>

<span class="s"> python importExcelSignals.py dynameq_net_dir dynameq_net_prefix excel_signals_dir startTime endTime output_dynameq_dir output_dynameq_net_prefix [overrideturntypes.csv]</span>
<span class="s"> </span>
<span class="s"> e.g.</span>
<span class="s"> </span>
<span class="s"> python importExcelSignals.py . sf Y:\dta\SanFrancisco\2010\excelSignalCards 15:30 18:30 Y:\dta\SanFrancisco\2010\network\movement_override.csv</span>
<span class="s"> </span>
<span class="s"> This script reads all the excel signal cards in the excel_signal_cards dir and converts them to the dynameq network</span>
<span class="s"> specified with the first two arguments.</span>
<span class="s"> </span>
<span class="s"> Only signals that are active in the given time period are converted.</span>
<span class="s"> </span>
<span class="s"> The script writes a new dynameq network that includes the signals to output_dynameq_dir using the prefix output_dynameq_net_prefix</span>
<span class="s"> &quot;&quot;&quot;</span>

<div class="viewcode-block" id="SignalData"><a class="viewcode-back" href="../script_importExcelSignals.html#importExcelSignals.SignalData">[docs]</a><span class="k">class</span> <span class="nc">SignalData</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class that represents the signal data for an intersection.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">attrNames</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;fileName&quot;</span><span class="p">,</span> <span class="s">&quot;iName&quot;</span><span class="p">,</span> <span class="s">&quot;topLeftCell&quot;</span><span class="p">,</span> <span class="s">&quot;phaseSeqCell&quot;</span><span class="p">,</span> <span class="s">&quot;pedPhaseCell&quot;</span><span class="p">,</span>\
                              <span class="s">&quot;sigInterCell&quot;</span><span class="p">,</span> <span class="s">&quot;colPhaseData&quot;</span><span class="p">,</span> <span class="s">&quot;lastColPhaseData&quot;</span><span class="p">]</span> \
                              <span class="o">+</span> <span class="p">[</span><span class="s">&quot;gMov</span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">9</span><span class="p">)]</span>
    <span class="n">streets</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;Street0&quot;</span><span class="p">,</span> <span class="s">&quot;Street1&quot;</span><span class="p">,</span> <span class="s">&quot;Street2&quot;</span><span class="p">,</span> <span class="s">&quot;Street3&quot;</span><span class="p">]</span>

    <span class="n">mappingInfo</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;IntersectionName(for mapping)&quot;</span><span class="p">,</span> <span class="s">&quot;mapped Intersection Name&quot;</span><span class="p">,</span> <span class="s">&quot;mapped Node id&quot;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>        

        <span class="bp">self</span><span class="o">.</span><span class="n">fileName</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iName</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iiName</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">topLeftCell</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">phaseSeqCell</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pedPhaseCell</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sigInterCell</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">colPhaseData</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lastColPhaseData</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">streetNames</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mappedNodeName</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mappedNodeId</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mappedNode</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mappedStreet</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mappedMovements</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>  <span class="c">#indexed by the keys of the mappedStreet </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">signalTiming</span> <span class="o">=</span> <span class="p">{}</span> <span class="c"># signal timing objects indexed by cso</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="c">#the group movement names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gMov1</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gMov2</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gMov3</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gMov4</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gMov5</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gMov6</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gMov7</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gMov8</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">phasingData</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sIntervals</span> <span class="o">=</span> <span class="p">{}</span>

<div class="viewcode-block" id="SignalData.toDict"><a class="viewcode-back" href="../script_importExcelSignals.html#importExcelSignals.SignalData.toDict">[docs]</a>    <span class="k">def</span> <span class="nf">toDict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">result</span><span class="p">[</span><span class="s">&quot;fileName&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileName</span>
        <span class="n">result</span><span class="p">[</span><span class="s">&quot;intersectionName&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iName</span>
        <span class="n">result</span><span class="p">[</span><span class="s">&quot;mappedNodeName&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mappedNodeName</span>
        <span class="n">result</span><span class="p">[</span><span class="s">&quot;mappedNodeId&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mappedNodeId</span>
        
        <span class="n">result</span><span class="p">[</span><span class="s">&quot;phasing&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">result</span><span class="p">[</span><span class="s">&quot;phasing&quot;</span><span class="p">][</span><span class="s">&quot;phaseNumbers&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phasingData</span><span class="o">.</span><span class="n">getElementsOfDimention</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">streetName</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phasingData</span><span class="o">.</span><span class="n">getElementsOfDimention</span><span class="p">(</span><span class="mi">0</span><span class="p">):</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">phaseElem</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phasingData</span><span class="p">[</span><span class="n">streetName</span><span class="p">,</span> <span class="p">:]:</span>
                <span class="n">tmp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">phaseElem</span><span class="p">)</span>
            <span class="n">result</span><span class="p">[</span><span class="s">&quot;phasing&quot;</span><span class="p">][</span><span class="n">streetName</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span>
        
        <span class="n">result</span><span class="p">[</span><span class="s">&quot;timeOfDayPhasing&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">signalTiming</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            
            <span class="n">result</span><span class="p">[</span><span class="s">&quot;timeOfDayPhasing&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">__dict__</span>
        <span class="k">return</span> <span class="n">result</span> 
        </div>
    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        
        <span class="n">str1</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">))</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">SignalData</span><span class="o">.</span><span class="n">attrNames</span><span class="p">])</span>
        <span class="n">streetNames</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;&quot;</span><span class="p">,]</span> <span class="o">*</span> <span class="mi">4</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">streetNames</span><span class="p">):</span>
            <span class="n">streetNames</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>
        <span class="n">str2</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">streetNames</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">str1</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span> <span class="o">+</span> <span class="n">str2</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">iiName</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">mappedNodeName</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">mappedNodeId</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        
        <span class="n">result</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\n\n</span><span class="si">%30s</span><span class="s">=</span><span class="si">%30s</span><span class="se">\n</span><span class="si">%30s</span><span class="s">=</span><span class="si">%30s</span><span class="se">\n</span><span class="si">%30s</span><span class="s">=</span><span class="si">%30s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&quot;FileName&quot;</span><span class="p">,</span> 
                     <span class="bp">self</span><span class="o">.</span><span class="n">fileName</span><span class="p">,</span> <span class="s">&quot;Intersection Name&quot;</span><span class="p">,</span> 
                       <span class="bp">self</span><span class="o">.</span><span class="n">iName</span><span class="p">,</span> <span class="s">&quot;Internal Intersection Name&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">iiName</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\n</span><span class="si">%30s</span><span class="s">=</span><span class="si">%30s</span><span class="se">\n</span><span class="si">%30s</span><span class="s">=</span><span class="si">%30s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&quot;mappedNodeName&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mappedNodeName</span><span class="p">,</span> <span class="s">&quot;mappedNodeId&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mappedNodeId</span><span class="p">)</span>
        
        <span class="n">result</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\n\n</span><span class="s">Phasing Data</span><span class="se">\n</span><span class="s">&quot;</span>
        <span class="n">result</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phasingData</span><span class="o">.</span><span class="n">asPrettyString</span><span class="p">()</span>
        
        <span class="n">result</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">Timing Data</span><span class="se">\n</span><span class="s">&quot;</span>
        <span class="k">for</span> <span class="n">signalTiming</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">signalTiming</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">result</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">signalTiming</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span> 

<div class="viewcode-block" id="SignalData.iterSignalTiming"><a class="viewcode-back" href="../script_importExcelSignals.html#importExcelSignals.SignalData.iterSignalTiming">[docs]</a>    <span class="k">def</span> <span class="nf">iterSignalTiming</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return an iterator to the signal Timing objects</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">signalTiming</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    </div>
<div class="viewcode-block" id="SignalData.getNumTimeIntervals"><a class="viewcode-back" href="../script_importExcelSignals.html#importExcelSignals.SignalData.getNumTimeIntervals">[docs]</a>    <span class="k">def</span> <span class="nf">getNumTimeIntervals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the number of time intervals</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">signalTiming</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">signalTiming</span><span class="o">.</span><span class="n">values</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
</div>
<div class="viewcode-block" id="SignalData.getPhases"><a class="viewcode-back" href="../script_importExcelSignals.html#importExcelSignals.SignalData.getPhases">[docs]</a>    <span class="k">def</span> <span class="nf">getPhases</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">startHour</span><span class="p">,</span> <span class="n">endHour</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the phases as list of dictionaries. By combining phasing data information</span>
<span class="sd">        such as the one in the following table </span>
<span class="sd">        </span>
<span class="sd">        ::</span>
<span class="sd">        </span>
<span class="sd">         Phasing Data</span>
<span class="sd">                            1  2  3  4  5  6  7  8</span>
<span class="sd">           GEARY BLVD (EB)  G  G  Y  R  R  R  R  R</span>
<span class="sd">             10TH AVE (SB)  R  R  R  R  G  G  Y  R</span>
<span class="sd">           GEARY BLVD (WB)  G  G  Y  R  R  R  R  R</span>
<span class="sd">             10TH AVE (NB)  R  R  R  R  G  G  Y  R</span>

<span class="sd">        And the signal interval data for the time of day that is specified</span>
<span class="sd">        by the startHour and endHour input arguments</span>
<span class="sd"> </span>
<span class="sd">	    Times: [47.0, 6.0, 3.5, 0.5, 8.0, 20.0, 3.5, 1.5]        </span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">pPhase</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">cPhase</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">phases</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">allRed</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="n">phasingData</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phasingData</span>
        <span class="n">groupMovements</span> <span class="o">=</span> <span class="n">phasingData</span><span class="o">.</span><span class="n">getElementsOfDimention</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">timeIndices</span> <span class="o">=</span> <span class="n">phasingData</span><span class="o">.</span><span class="n">getElementsOfDimention</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">timeIntervals</span> <span class="o">=</span> <span class="n">selectCSO</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">startHour</span><span class="p">,</span> <span class="n">endHour</span><span class="p">)</span><span class="o">.</span><span class="n">times</span>
        <span class="n">lastIndex</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">timeIndices</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">timeIndex1</span><span class="p">,</span> <span class="n">dur1</span> <span class="ow">in</span> <span class="n">izip</span><span class="p">(</span><span class="n">timeIndices</span><span class="p">,</span> <span class="n">timeIntervals</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">states</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">phasingData</span><span class="p">[:,</span> <span class="n">timeIndex1</span><span class="p">]))</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">print</span> <span class="n">e</span>
                <span class="k">raise</span> <span class="n">SignalConversionError</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            
            <span class="n">cGreenMovs</span> <span class="o">=</span> <span class="p">[</span><span class="n">gMov</span> <span class="k">for</span> <span class="n">gMov</span> <span class="ow">in</span> <span class="n">groupMovements</span> <span class="k">if</span> <span class="n">phasingData</span><span class="p">[</span><span class="n">gMov</span><span class="p">,</span> <span class="n">timeIndex1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;G&quot;</span><span class="p">]</span> 
            <span class="n">cYellowMovs</span> <span class="o">=</span> <span class="p">[</span><span class="n">gMov</span> <span class="k">for</span> <span class="n">gMov</span> <span class="ow">in</span> <span class="n">groupMovements</span> <span class="k">if</span> <span class="n">phasingData</span><span class="p">[</span><span class="n">gMov</span><span class="p">,</span> <span class="n">timeIndex1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;Y&quot;</span><span class="p">]</span>
            <span class="n">cRedMovs</span> <span class="o">=</span> <span class="p">[</span><span class="n">gMov</span> <span class="k">for</span> <span class="n">gMov</span> <span class="ow">in</span> <span class="n">groupMovements</span> <span class="k">if</span> <span class="n">phasingData</span><span class="p">[</span><span class="n">gMov</span><span class="p">,</span> <span class="n">timeIndex1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;R&quot;</span><span class="p">]</span>

            <span class="n">gMatches</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">yMatches</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">rMatches</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">pPhase</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">gMovs</span> <span class="ow">in</span> <span class="n">cGreenMovs</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">gMovs</span> <span class="ow">in</span> <span class="n">pPhase</span><span class="p">[</span><span class="s">&quot;Movs&quot;</span><span class="p">]:</span>
                        <span class="n">gMatches</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">for</span> <span class="n">yMovs</span> <span class="ow">in</span> <span class="n">cYellowMovs</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">yMovs</span> <span class="ow">in</span> <span class="n">pPhase</span><span class="p">[</span><span class="s">&quot;Movs&quot;</span><span class="p">]:</span>
                        <span class="n">yMatches</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">for</span> <span class="n">rMovs</span> <span class="ow">in</span> <span class="n">cRedMovs</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">rMovs</span> <span class="ow">in</span> <span class="n">pPhase</span><span class="p">[</span><span class="s">&quot;Movs&quot;</span><span class="p">]:</span>
                        <span class="n">rMatches</span> <span class="o">+=</span> <span class="mi">1</span>
                            
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pPhase</span><span class="p">[</span><span class="s">&quot;Movs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cGreenMovs</span>
                <span class="n">pPhase</span><span class="p">[</span><span class="s">&quot;green&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dur1</span>
                <span class="n">pPhase</span><span class="p">[</span><span class="s">&quot;yellow&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">pPhase</span><span class="p">[</span><span class="s">&quot;allRed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cGreenMovs</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">cYellowMovs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">gMatches</span> <span class="o">+</span> <span class="n">yMatches</span><span class="p">):</span>
                <span class="n">phases</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pPhase</span><span class="p">)</span>
                <span class="n">pPhase</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">pPhase</span><span class="p">[</span><span class="s">&quot;Movs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cGreenMovs</span>
                <span class="n">pPhase</span><span class="p">[</span><span class="s">&quot;green&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dur1</span>
                <span class="n">pPhase</span><span class="p">[</span><span class="s">&quot;yellow&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">pPhase</span><span class="p">[</span><span class="s">&quot;allRed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">elif</span> <span class="n">gMatches</span> <span class="o">+</span> <span class="n">yMatches</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">pPhase</span><span class="p">[</span><span class="s">&quot;Movs&quot;</span><span class="p">]):</span>
                <span class="k">if</span> <span class="n">yMatches</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">pPhase</span><span class="p">[</span><span class="s">&quot;yellow&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dur1</span>
                <span class="k">elif</span> <span class="n">rMatches</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">pPhase</span><span class="p">[</span><span class="s">&quot;allRed&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dur1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">pPhase</span><span class="p">[</span><span class="s">&quot;green&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dur1</span>
            <span class="k">elif</span> <span class="n">gMatches</span> <span class="o">+</span> <span class="n">yMatches</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">pPhase</span><span class="p">[</span><span class="s">&quot;Movs&quot;</span><span class="p">])</span> <span class="ow">and</span> <span class="n">gMatches</span> <span class="o">+</span> <span class="n">yMatches</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">phases</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pPhase</span><span class="p">)</span>
                <span class="n">pPhase</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">if</span> <span class="n">yMatches</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">pPhase</span><span class="p">[</span><span class="s">&quot;Movs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cGreenMovs</span>
                    <span class="n">pPhase</span><span class="p">[</span><span class="s">&quot;green&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dur1</span>
                    <span class="n">pPhase</span><span class="p">[</span><span class="s">&quot;yellow&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">pPhase</span><span class="p">[</span><span class="s">&quot;allRed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">pPhase</span><span class="p">[</span><span class="s">&quot;Movs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cYellowMovs</span>
                    <span class="n">pPhase</span><span class="p">[</span><span class="s">&quot;green&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">pPhase</span><span class="p">[</span><span class="s">&quot;yellow&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dur1</span>
                    <span class="n">pPhase</span><span class="p">[</span><span class="s">&quot;allRed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">elif</span> <span class="n">rMatches</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">pPhase</span><span class="p">[</span><span class="s">&quot;Movs&quot;</span><span class="p">])</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">cGreenMovs</span><span class="p">:</span>
                <span class="n">pPhase</span><span class="p">[</span><span class="s">&quot;allRed&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dur1</span>
            <span class="k">elif</span> <span class="n">rMatches</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">pPhase</span><span class="p">[</span><span class="s">&quot;Movs&quot;</span><span class="p">])</span> <span class="ow">and</span> <span class="n">cGreenMovs</span><span class="p">:</span>
                <span class="n">phases</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pPhase</span><span class="p">)</span>
                <span class="n">pPhase</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">pPhase</span><span class="p">[</span><span class="s">&quot;Movs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cGreenMovs</span>
                <span class="n">pPhase</span><span class="p">[</span><span class="s">&quot;green&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dur1</span>
                <span class="n">pPhase</span><span class="p">[</span><span class="s">&quot;yellow&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">pPhase</span><span class="p">[</span><span class="s">&quot;allRed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                
            <span class="k">else</span><span class="p">:</span>
                <span class="n">phases</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pPhase</span><span class="p">)</span>
                <span class="n">pPhase</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">pPhase</span><span class="p">[</span><span class="s">&quot;Movs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cActiveMovs</span>
                <span class="n">pPhase</span><span class="p">[</span><span class="s">&quot;green&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dur1</span>
                <span class="n">pPhase</span><span class="p">[</span><span class="s">&quot;yellow&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">pPhase</span><span class="p">[</span><span class="s">&quot;allRed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">if</span> <span class="n">timeIndex1</span> <span class="o">==</span> <span class="n">lastIndex</span><span class="p">:</span>
                <span class="n">phases</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pPhase</span><span class="p">)</span>
            
        <span class="k">return</span> <span class="n">phases</span>
</div>
<div class="viewcode-block" id="SignalData.selectCSO"><a class="viewcode-back" href="../script_importExcelSignals.html#importExcelSignals.SignalData.selectCSO">[docs]</a>    <span class="k">def</span> <span class="nf">selectCSO</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">startTime</span><span class="p">,</span> <span class="n">endTime</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        returns the ExcelSignalTiming if there is one that is in operation during the </span>
<span class="sd">        input hours. Otherwise it returns none</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">cso</span><span class="p">,</span> <span class="n">signalTiming</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">signalTiming</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span> 
            <span class="k">if</span> <span class="n">startTime</span> <span class="o">&gt;=</span> <span class="n">signalTiming</span><span class="o">.</span><span class="n">startTime</span> <span class="ow">and</span> <span class="n">startTime</span> <span class="o">&lt;=</span> <span class="n">signalTiming</span><span class="o">.</span><span class="n">endTime</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">cso</span>

        <span class="k">for</span> <span class="n">cso</span><span class="p">,</span> <span class="n">signalTiming</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">signalTiming</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span> 
            <span class="k">if</span> <span class="n">signalTiming</span><span class="o">.</span><span class="n">startTime</span> <span class="o">==</span> <span class="n">dta</span><span class="o">.</span><span class="n">Time</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="n">signalTiming</span><span class="o">.</span><span class="n">endTime</span> <span class="o">==</span> <span class="n">dta</span><span class="o">.</span><span class="n">Time</span><span class="p">(</span><span class="mi">23</span><span class="p">,</span><span class="mi">59</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">cso</span>
        <span class="k">for</span> <span class="n">cso</span><span class="p">,</span> <span class="n">signalTiming</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">signalTiming</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span> 
            <span class="k">if</span> <span class="n">signalTiming</span><span class="o">.</span><span class="n">startTime</span> <span class="o">==</span> <span class="n">dta</span><span class="o">.</span><span class="n">Time</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="n">signalTiming</span><span class="o">.</span><span class="n">endTime</span> <span class="o">==</span> <span class="n">dta</span><span class="o">.</span><span class="n">Time</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">cso</span>
        <span class="k">return</span> <span class="bp">None</span>
</div></div>
<div class="viewcode-block" id="PhaseState"><a class="viewcode-back" href="../script_importExcelSignals.html#importExcelSignals.PhaseState">[docs]</a><span class="k">class</span> <span class="nc">PhaseState</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Represents the state of a phase for a specfic duration</span>
<span class="sd">    The state can be one of GREEN, YELLOW and RED:</span>
<span class="sd">    and the duration is a floating number</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">GREEN</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">YELLOW</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">RED</span> <span class="o">=</span> <span class="mi">2</span>    

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">duration</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">state</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">duration</span> <span class="o">=</span> <span class="n">duration</span>
</div>
<div class="viewcode-block" id="ExcelSignalTiming"><a class="viewcode-back" href="../script_importExcelSignals.html#importExcelSignals.ExcelSignalTiming">[docs]</a><span class="k">class</span> <span class="nc">ExcelSignalTiming</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Contains the timing information for a particular period</span>

<span class="sd">    the timing consists of a list of floating numbers that each of which </span>
<span class="sd">    corresponds to a different state of the timing plan</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">DEFAULT_VALUE</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">DEFAULT_OFFSET</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cso</span> <span class="o">=</span> <span class="n">ExcelSignalTiming</span><span class="o">.</span><span class="n">DEFAULT_VALUE</span>   <span class="c"># string the cso value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cycle</span> <span class="o">=</span> <span class="n">ExcelSignalTiming</span><span class="o">.</span><span class="n">DEFAULT_VALUE</span>  <span class="c">#float the cycle length </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">ExcelSignalTiming</span><span class="o">.</span><span class="n">DEFAULT_OFFSET</span>  <span class="c"># float the offset</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">isActuated</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">startTime</span> <span class="o">=</span> <span class="n">dta</span><span class="o">.</span><span class="n">Time</span><span class="p">(</span><span class="mi">23</span><span class="p">,</span><span class="mi">59</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">endTime</span> <span class="o">=</span> <span class="n">dta</span><span class="o">.</span><span class="n">Time</span><span class="p">(</span><span class="mi">23</span><span class="p">,</span><span class="mi">59</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">times</span> <span class="o">=</span> <span class="p">()</span>
        
<div class="viewcode-block" id="ExcelSignalTiming.setPhaseTimes"><a class="viewcode-back" href="../script_importExcelSignals.html#importExcelSignals.ExcelSignalTiming.setPhaseTimes">[docs]</a>    <span class="k">def</span> <span class="nf">setPhaseTimes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">times</span><span class="p">):</span>        

        <span class="k">for</span> <span class="n">time</span> <span class="ow">in</span> <span class="n">times</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">ExcelSignalTimingError</span><span class="p">(</span><span class="s">&quot;Time values corresponding to phase states have to be float &quot;</span>
                                       <span class="s">&quot;values and not: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">times</span> <span class="o">=</span> <span class="n">times</span>
</div>
    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return an iterator over the phase states</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the number of intevals of the time plan</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getNumIntervals</span><span class="p">()</span>

<div class="viewcode-block" id="ExcelSignalTiming.getNumIntervals"><a class="viewcode-back" href="../script_importExcelSignals.html#importExcelSignals.ExcelSignalTiming.getNumIntervals">[docs]</a>    <span class="k">def</span> <span class="nf">getNumIntervals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the number of intevals of the time plan</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">times</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the string representation of the signal card</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__repr__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the string representation of the signal card</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cycle</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">cycle</span> <span class="o">=</span> <span class="n">ExcelSignalTiming</span><span class="o">.</span><span class="n">DEFAULT_VALUE</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cycle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cycle</span> 

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="n">ExcelSignalTiming</span><span class="o">.</span><span class="n">DEFAULT_VALUE</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset</span>
        
        <span class="n">result</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">cso= </span><span class="si">%s</span><span class="s"> </span><span class="se">\n</span><span class="s">cycle= </span><span class="si">%.1f</span><span class="s"> </span><span class="se">\n</span><span class="s">offset= </span><span class="si">%.1f</span><span class="s"> </span><span class="se">\n</span><span class="s">startTime= </span><span class="si">%s</span><span class="s"> &quot;</span> \
            <span class="s">&quot;endtime= </span><span class="si">%s</span><span class="s"> </span><span class="se">\n</span><span class="s">isActuated </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cso</span><span class="p">,</span> <span class="n">cycle</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span>
                                          <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">startTime</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">endTime</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">isActuated</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\n\t</span><span class="s">Times: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">times</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span>
                                                  </div>
<div class="viewcode-block" id="findTopLeftCell"><a class="viewcode-back" href="../script_importExcelSignals.html#importExcelSignals.findTopLeftCell">[docs]</a><span class="k">def</span> <span class="nf">findTopLeftCell</span><span class="p">(</span><span class="n">sheet</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Find the top left cell of the signal card containing </span>
<span class="sd">    the intersection name and return its coordinates&quot;&quot;&quot;</span>

    <span class="n">MAX_RANGE</span> <span class="o">=</span> <span class="mi">10</span> <span class="c"># max range to look for the top left cell </span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">MAX_RANGE</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">MAX_RANGE</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">sheet</span><span class="o">.</span><span class="n">cell_value</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">))</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span>

    <span class="k">raise</span> <span class="n">ParsingCardError</span><span class="p">(</span><span class="s">&quot;I cannot find top left cell of the sheet containing &quot;</span>
                           <span class="s">&quot;the intersection name&quot;</span><span class="p">)</span>

        </div>
<div class="viewcode-block" id="getIntersectionName"><a class="viewcode-back" href="../script_importExcelSignals.html#importExcelSignals.getIntersectionName">[docs]</a><span class="k">def</span> <span class="nf">getIntersectionName</span><span class="p">(</span><span class="n">sheet</span><span class="p">,</span> <span class="n">topLeftCell</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the intersection name as found in the excel card. </span>
<span class="sd">    TopLeftCell is a tuble that contains the location of the top left cell</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">sheet</span><span class="o">.</span><span class="n">cell_value</span><span class="p">(</span><span class="n">topLeftCell</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">topLeftCell</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="findStreet"><a class="viewcode-back" href="../script_importExcelSignals.html#importExcelSignals.findStreet">[docs]</a><span class="k">def</span> <span class="nf">findStreet</span><span class="p">(</span><span class="n">sheet</span><span class="p">,</span> <span class="n">topLeftCell</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Find the cell containing the STREET keyword that marks</span>
<span class="sd">    the beggining of the phase sequencing information and return </span>
<span class="sd">    its coordinates. If unsuccesfull raiseParsingCardError&quot;&quot;&quot;</span>
    <span class="n">CELLS_TO_SEARCH</span> <span class="o">=</span> <span class="mi">40</span>
    <span class="n">START_PHASE_SECTION</span> <span class="o">=</span> <span class="s">&quot;STREET&quot;</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">CELLS_TO_SEARCH</span><span class="p">):</span>
        <span class="n">cell</span> <span class="o">=</span> <span class="p">(</span><span class="n">topLeftCell</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">row</span><span class="p">,</span> <span class="n">topLeftCell</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">sheet</span><span class="o">.</span><span class="n">cell_value</span><span class="p">(</span><span class="n">rowx</span><span class="o">=</span><span class="n">cell</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">colx</span><span class="o">=</span><span class="n">cell</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">START_PHASE_SECTION</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">cell</span>
    <span class="k">raise</span> <span class="n">ParsingCardError</span><span class="p">(</span><span class="s">&quot;I cannot find the start of the phasing section&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="findPedestrianPhase"><a class="viewcode-back" href="../script_importExcelSignals.html#importExcelSignals.findPedestrianPhase">[docs]</a><span class="k">def</span> <span class="nf">findPedestrianPhase</span><span class="p">(</span><span class="n">sheet</span><span class="p">,</span> <span class="n">topLeftCell</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find the cell that corresponds to the pedestrian phase.</span>
<span class="sd">    If not such cell exists it returns None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">CELLS_TO_SEARCH</span> <span class="o">=</span> <span class="mi">60</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">CELLS_TO_SEARCH</span><span class="p">):</span>
        <span class="n">cell</span> <span class="o">=</span> <span class="p">(</span><span class="n">topLeftCell</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">row</span><span class="p">,</span> <span class="n">topLeftCell</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">sheet</span><span class="o">.</span><span class="n">cell_value</span><span class="p">(</span><span class="n">rowx</span><span class="o">=</span><span class="n">cell</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">colx</span><span class="o">=</span><span class="n">cell</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="s">&quot;PEDS &quot;</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">or</span> \
                <span class="s">&quot;PED &quot;</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">or</span> \
                <span class="s">&quot;XING &quot;</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">or</span> \
                <span class="s">&quot;MUNI &quot;</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">or</span> \
                <span class="s">&quot;TRAIN &quot;</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">or</span>\
                <span class="s">&quot;FLASHING &quot;</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">cell</span>
    <span class="k">return</span> <span class="bp">None</span>    
</div>
<div class="viewcode-block" id="findSignalIntervals"><a class="viewcode-back" href="../script_importExcelSignals.html#importExcelSignals.findSignalIntervals">[docs]</a><span class="k">def</span> <span class="nf">findSignalIntervals</span><span class="p">(</span><span class="n">sheet</span><span class="p">,</span> <span class="n">topLeftCell</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find the cell that contains the Cycle and Offset infrmation</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">CELLS_TO_SEARCH</span> <span class="o">=</span> <span class="mi">80</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">CELLS_TO_SEARCH</span><span class="p">):</span>
        <span class="n">cell</span> <span class="o">=</span> <span class="p">(</span><span class="n">topLeftCell</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">row</span><span class="p">,</span> <span class="n">topLeftCell</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">sheet</span><span class="o">.</span><span class="n">cell_value</span><span class="p">(</span><span class="n">rowx</span><span class="o">=</span><span class="n">cell</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">colx</span><span class="o">=</span><span class="n">cell</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="s">&quot;CSO&quot;</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">or</span> <span class="s">&quot;DIAL&quot;</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">cell</span>
    <span class="k">raise</span> <span class="n">ParsingCardError</span><span class="p">(</span><span class="s">&quot;I cannot find the start of the singal interval field &quot;</span>
                           <span class="s">&quot;marked by the keyworkd CSO or DIAL&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="getFirstColumnOfPhasingData"><a class="viewcode-back" href="../script_importExcelSignals.html#importExcelSignals.getFirstColumnOfPhasingData">[docs]</a><span class="k">def</span> <span class="nf">getFirstColumnOfPhasingData</span><span class="p">(</span><span class="n">sheet</span><span class="p">,</span> <span class="n">signalData</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Search the cells in the spreadsheet to find and return the cell that</span>
<span class="sd">    contains phase state 1</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">signalData</span><span class="o">.</span><span class="n">phaseSeqCell</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ParsingCardError</span><span class="p">(</span><span class="s">&quot;I cannot locate the first column of the phasing data &quot;</span>
                               <span class="s">&quot;because the phase data section has not been previously identified&quot;</span><span class="p">)</span>
    
    <span class="n">NUM_COL_TO_SEARCH</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="n">startX</span><span class="p">,</span> <span class="n">startY</span> <span class="o">=</span> <span class="n">signalData</span><span class="o">.</span><span class="n">phaseSeqCell</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span> <span class="p">(</span><span class="n">startY</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">startY</span> <span class="o">+</span> <span class="n">NUM_COL_TO_SEARCH</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">sheet</span><span class="o">.</span><span class="n">cell_value</span><span class="p">(</span><span class="n">rowx</span><span class="o">=</span><span class="n">startX</span><span class="p">,</span> <span class="n">colx</span><span class="o">=</span><span class="n">col</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c"># one is the first phase</span>
            <span class="n">signalData</span><span class="o">.</span><span class="n">colPhaseData</span> <span class="o">=</span> <span class="n">col</span>
            <span class="k">return</span>
    <span class="k">raise</span> <span class="n">ParsingCardError</span><span class="p">(</span><span class="s">&quot;I cannot locate the first column of the phasing data &quot;</span>
                           <span class="s">&quot;identified by the keyword 1 in the same row with the &quot;</span>
                           <span class="s">&quot;STREET keyword&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="checkForWeekdayPlan"><a class="viewcode-back" href="../script_importExcelSignals.html#importExcelSignals.checkForWeekdayPlan">[docs]</a><span class="k">def</span> <span class="nf">checkForWeekdayPlan</span><span class="p">(</span><span class="n">sheet</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">column</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Checks the plan data to see if the CSO is used on weekdays (Thursday and Friday) </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ThursValue</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">sheet</span><span class="o">.</span><span class="n">cell_value</span><span class="p">(</span><span class="n">row</span><span class="p">,</span><span class="n">column</span><span class="o">-</span><span class="mi">3</span><span class="p">))</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">FriValue</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">sheet</span><span class="o">.</span><span class="n">cell_value</span><span class="p">(</span><span class="n">row</span><span class="p">,</span><span class="n">column</span><span class="o">-</span><span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">ThursValue</span><span class="o">==</span><span class="s">&quot;X&quot;</span> <span class="ow">and</span> <span class="n">FriValue</span><span class="o">==</span><span class="s">&quot;X&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">True</span>
    <span class="k">elif</span> <span class="n">ThursValue</span><span class="o">==</span><span class="s">&quot;x&quot;</span> <span class="ow">and</span> <span class="n">FriValue</span><span class="o">==</span><span class="s">&quot;x&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>
    </div>
<div class="viewcode-block" id="getOperationTimes"><a class="viewcode-back" href="../script_importExcelSignals.html#importExcelSignals.getOperationTimes">[docs]</a><span class="k">def</span> <span class="nf">getOperationTimes</span><span class="p">(</span><span class="n">sheet</span><span class="p">,</span> <span class="n">signalData</span><span class="p">):</span>


    <span class="n">dta</span><span class="o">.</span><span class="n">DtaLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;I am parsing the operating times for signal </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">signalData</span><span class="o">.</span><span class="n">fileName</span><span class="p">)</span>
                       
    <span class="n">i</span> <span class="o">=</span> <span class="n">signalData</span><span class="o">.</span><span class="n">topLeftCell</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">12</span>
    <span class="n">j</span> <span class="o">=</span> <span class="n">signalData</span><span class="o">.</span><span class="n">colPhaseData</span>

    <span class="k">def</span> <span class="nf">setTimes</span><span class="p">(</span><span class="n">row</span><span class="p">,</span><span class="n">colCycle</span><span class="p">,</span><span class="n">sheet</span><span class="p">):</span>
        <span class="n">hasAllOtherTimes</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">gotStartTime</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">gotStartTime2</span><span class="o">=</span><span class="bp">False</span>

        
        <span class="k">for</span> <span class="n">curColumn</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">signalData</span><span class="o">.</span><span class="n">topLeftCell</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">signalData</span><span class="o">.</span><span class="n">colPhaseData</span><span class="p">):</span>
            <span class="n">cellValue</span> <span class="o">=</span> <span class="n">sheet</span><span class="o">.</span><span class="n">cell_value</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">curColumn</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">cellValue</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                <span class="c"># Check to see if CSO applies to weekdays and if not, set times to 23:59 to 23:59</span>
                <span class="n">isWeekdayPlan</span> <span class="o">=</span> <span class="n">checkForWeekdayPlan</span><span class="p">(</span><span class="n">sheet</span><span class="p">,</span><span class="n">row</span><span class="p">,</span><span class="n">colCycle</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">isWeekdayPlan</span><span class="p">:</span>
                    <span class="n">signalData</span><span class="o">.</span><span class="n">signalTiming</span><span class="p">[</span><span class="n">strCso</span><span class="p">]</span><span class="o">.</span><span class="n">startTime</span> <span class="o">=</span> <span class="n">dta</span><span class="o">.</span><span class="n">Time</span><span class="p">(</span><span class="mi">23</span><span class="p">,</span><span class="mi">59</span><span class="p">)</span>
                    <span class="n">signalData</span><span class="o">.</span><span class="n">signalTiming</span><span class="p">[</span><span class="n">strCso</span><span class="p">]</span><span class="o">.</span><span class="n">endTime</span> <span class="o">=</span> <span class="n">dta</span><span class="o">.</span><span class="n">Time</span><span class="p">(</span><span class="mi">23</span><span class="p">,</span><span class="mi">59</span><span class="p">)</span>
                    <span class="n">gotStartTime</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="c"># If CSO does include weekdays, check time format and get signal times</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cellValue</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">cellValue</span> <span class="o">==</span> <span class="mf">1.0</span><span class="p">:</span>
                        <span class="n">time</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">time</span> <span class="o">=</span> <span class="n">xlrd</span><span class="o">.</span><span class="n">xldate_as_tuple</span><span class="p">(</span><span class="n">cellValue</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">gotStartTime</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span>
                        <span class="n">signalData</span><span class="o">.</span><span class="n">signalTiming</span><span class="p">[</span><span class="n">strCso</span><span class="p">]</span><span class="o">.</span><span class="n">startTime</span> <span class="o">=</span> <span class="n">dta</span><span class="o">.</span><span class="n">Time</span><span class="p">(</span><span class="n">time</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">time</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
                        <span class="n">gotStartTime</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">signalData</span><span class="o">.</span><span class="n">signalTiming</span><span class="p">[</span><span class="n">strCso</span><span class="p">]</span><span class="o">.</span><span class="n">endTime</span> <span class="o">=</span> <span class="n">dta</span><span class="o">.</span><span class="n">Time</span><span class="p">(</span><span class="n">time</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">time</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
                <span class="k">elif</span> <span class="s">&quot;event&quot;</span> <span class="ow">in</span> <span class="n">cellValue</span> <span class="ow">or</span> <span class="s">&quot;Event&quot;</span> <span class="ow">in</span> <span class="n">cellValue</span> <span class="ow">or</span> <span class="s">&quot;Game&quot;</span> <span class="ow">in</span> <span class="n">cellValue</span><span class="p">:</span>
                    <span class="n">signalData</span><span class="o">.</span><span class="n">signalTiming</span><span class="p">[</span><span class="n">strCso</span><span class="p">]</span><span class="o">.</span><span class="n">startTime</span> <span class="o">=</span> <span class="n">dta</span><span class="o">.</span><span class="n">Time</span><span class="p">(</span><span class="mi">23</span><span class="p">,</span><span class="mi">59</span><span class="p">)</span>
                    <span class="n">signalData</span><span class="o">.</span><span class="n">signalTiming</span><span class="p">[</span><span class="n">strCso</span><span class="p">]</span><span class="o">.</span><span class="n">endTime</span> <span class="o">=</span> <span class="n">dta</span><span class="o">.</span><span class="n">Time</span><span class="p">(</span><span class="mi">23</span><span class="p">,</span><span class="mi">59</span><span class="p">)</span>
                <span class="k">elif</span> <span class="s">&quot;TIMES&quot;</span> <span class="ow">in</span> <span class="n">cellValue</span> <span class="ow">or</span> <span class="s">&quot;Times&quot;</span> <span class="ow">in</span> <span class="n">cellValue</span><span class="p">:</span>
                    <span class="n">hasAllOtherTimes</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="n">signalData</span><span class="o">.</span><span class="n">signalTiming</span><span class="p">[</span><span class="n">strCso</span><span class="p">]</span><span class="o">.</span><span class="n">startTime</span> <span class="o">=</span> <span class="n">dta</span><span class="o">.</span><span class="n">Time</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">signalData</span><span class="o">.</span><span class="n">signalTiming</span><span class="p">[</span><span class="n">strCso</span><span class="p">]</span><span class="o">.</span><span class="n">endTime</span> <span class="o">=</span> <span class="n">dta</span><span class="o">.</span><span class="n">Time</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">gotStartTime</span> <span class="o">=</span> <span class="bp">True</span>
                    
                <span class="k">elif</span> <span class="n">gotStartTime</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s">&quot;-&quot;</span> <span class="ow">in</span> <span class="n">cellValue</span> <span class="ow">and</span> <span class="ow">not</span> <span class="s">&quot;:&quot;</span> <span class="ow">in</span> <span class="n">cellValue</span> <span class="ow">and</span> <span class="ow">not</span> <span class="s">&quot; - &quot;</span> <span class="ow">in</span> <span class="n">cellValue</span><span class="p">:</span>
                        <span class="n">cellValue</span> <span class="o">=</span> <span class="n">cellValue</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                        <span class="n">startTime1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cellValue</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span>
                        <span class="n">startTime2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cellValue</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">])</span>
                        <span class="n">endTime1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cellValue</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="mi">7</span><span class="p">])</span>
                        <span class="n">endTime2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cellValue</span><span class="p">[</span><span class="mi">7</span><span class="p">:])</span>
                        <span class="n">signalData</span><span class="o">.</span><span class="n">signalTiming</span><span class="p">[</span><span class="n">strCso</span><span class="p">]</span><span class="o">.</span><span class="n">startTime</span> <span class="o">=</span> <span class="n">dta</span><span class="o">.</span><span class="n">Time</span><span class="p">(</span><span class="n">startTime1</span><span class="p">,</span> <span class="n">startTime2</span><span class="p">)</span>
                        <span class="n">signalData</span><span class="o">.</span><span class="n">signalTiming</span><span class="p">[</span><span class="n">strCso</span><span class="p">]</span><span class="o">.</span><span class="n">endTime</span> <span class="o">=</span> <span class="n">dta</span><span class="o">.</span><span class="n">Time</span><span class="p">(</span><span class="n">endTime1</span><span class="p">,</span> <span class="n">endTime2</span><span class="p">)</span>
                        <span class="n">gotStartTime</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="k">if</span> <span class="s">&quot; - &quot;</span> <span class="ow">in</span> <span class="n">cellValue</span> <span class="ow">and</span> <span class="ow">not</span> <span class="s">&quot;:&quot;</span> <span class="ow">in</span> <span class="n">cellValue</span><span class="p">:</span>
                        <span class="n">cellValue</span> <span class="o">=</span> <span class="n">cellValue</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                        <span class="n">startTime1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cellValue</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span>
                        <span class="n">startTime2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cellValue</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">])</span>
                        <span class="n">endTime1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cellValue</span><span class="p">[</span><span class="mi">7</span><span class="p">:</span><span class="mi">9</span><span class="p">])</span>
                        <span class="n">endTime2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cellValue</span><span class="p">[</span><span class="mi">9</span><span class="p">:])</span>
                        <span class="k">if</span> <span class="n">endTime1</span> <span class="o">==</span> <span class="mi">24</span><span class="p">:</span>
                            <span class="n">endTime1</span> <span class="o">=</span> <span class="mi">23</span>
                            <span class="n">endTime2</span> <span class="o">=</span> <span class="mi">59</span>
                        <span class="n">signalData</span><span class="o">.</span><span class="n">signalTiming</span><span class="p">[</span><span class="n">strCso</span><span class="p">]</span><span class="o">.</span><span class="n">startTime</span> <span class="o">=</span> <span class="n">dta</span><span class="o">.</span><span class="n">Time</span><span class="p">(</span><span class="n">startTime1</span><span class="p">,</span> <span class="n">startTime2</span><span class="p">)</span>
                        <span class="n">signalData</span><span class="o">.</span><span class="n">signalTiming</span><span class="p">[</span><span class="n">strCso</span><span class="p">]</span><span class="o">.</span><span class="n">endTime</span> <span class="o">=</span> <span class="n">dta</span><span class="o">.</span><span class="n">Time</span><span class="p">(</span><span class="n">endTime1</span><span class="p">,</span> <span class="n">endTime2</span><span class="p">)</span>
                        <span class="n">gotStartTime</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="k">if</span> <span class="s">&quot;-&quot;</span> <span class="ow">in</span> <span class="n">cellValue</span> <span class="ow">and</span> <span class="s">&quot;:&quot;</span> <span class="ow">in</span> <span class="n">cellValue</span><span class="p">:</span>
                        <span class="n">stopval</span> <span class="o">=</span> <span class="n">cellValue</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;-&quot;</span><span class="p">)</span>
                        <span class="n">startTimeAll</span> <span class="o">=</span> <span class="n">cellValue</span><span class="p">[:</span><span class="n">stopval</span><span class="p">]</span>
                        <span class="n">colonval</span> <span class="o">=</span> <span class="n">startTimeAll</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;:&quot;</span><span class="p">)</span>
                        <span class="n">startTime1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">startTimeAll</span><span class="p">[:</span><span class="n">colonval</span><span class="p">])</span>
                        <span class="n">startTime2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">startTimeAll</span><span class="p">[</span><span class="n">colonval</span><span class="o">+</span><span class="mi">1</span><span class="p">:])</span>
                        <span class="n">signalData</span><span class="o">.</span><span class="n">signalTiming</span><span class="p">[</span><span class="n">strCso</span><span class="p">]</span><span class="o">.</span><span class="n">startTime</span> <span class="o">=</span> <span class="n">dta</span><span class="o">.</span><span class="n">Time</span><span class="p">(</span><span class="n">startTime1</span><span class="p">,</span> <span class="n">startTime2</span><span class="p">)</span>
                        <span class="n">endTimeAll</span> <span class="o">=</span> <span class="n">cellValue</span><span class="p">[</span><span class="n">stopval</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
                        <span class="n">colonval</span> <span class="o">=</span> <span class="n">endTimeAll</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;:&quot;</span><span class="p">)</span>
                        <span class="n">endTime1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">endTimeAll</span><span class="p">[:</span><span class="n">colonval</span><span class="p">])</span>
                        <span class="n">endTime2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">endTimeAll</span><span class="p">[</span><span class="n">colonval</span><span class="o">+</span><span class="mi">1</span><span class="p">:])</span>
                        <span class="n">signalData</span><span class="o">.</span><span class="n">signalTiming</span><span class="p">[</span><span class="n">strCso</span><span class="p">]</span><span class="o">.</span><span class="n">endTime</span> <span class="o">=</span> <span class="n">dta</span><span class="o">.</span><span class="n">Time</span><span class="p">(</span><span class="n">endTime1</span><span class="p">,</span> <span class="n">endTime2</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="s">&quot;:&quot;</span> <span class="ow">in</span> <span class="n">cellValue</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">cellValue</span><span class="p">)</span><span class="o">==</span><span class="mi">5</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">gotStartTime2</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span>
                            <span class="n">startTime1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cellValue</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span>
                            <span class="n">startTime2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cellValue</span><span class="p">[</span><span class="mi">3</span><span class="p">:])</span>
                            <span class="n">signalData</span><span class="o">.</span><span class="n">signalTiming</span><span class="p">[</span><span class="n">strCso</span><span class="p">]</span><span class="o">.</span><span class="n">startTime</span> <span class="o">=</span> <span class="n">dta</span><span class="o">.</span><span class="n">Time</span><span class="p">(</span><span class="n">startTime1</span><span class="p">,</span> <span class="n">startTime2</span><span class="p">)</span>
                            <span class="n">gotStartTime2</span> <span class="o">=</span> <span class="bp">True</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">endTime1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cellValue</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span>
                            <span class="n">endTime2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cellValue</span><span class="p">[</span><span class="mi">3</span><span class="p">:])</span>
                            <span class="n">signalData</span><span class="o">.</span><span class="n">signalTiming</span><span class="p">[</span><span class="n">strCso</span><span class="p">]</span><span class="o">.</span><span class="n">endTime</span> <span class="o">=</span> <span class="n">dta</span><span class="o">.</span><span class="n">Time</span><span class="p">(</span><span class="n">endTime1</span><span class="p">,</span> <span class="n">endTime2</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="s">&quot;:&quot;</span> <span class="ow">in</span> <span class="n">cellValue</span> <span class="ow">and</span> <span class="s">&quot;TO&quot;</span> <span class="ow">in</span> <span class="n">cellValue</span><span class="p">:</span>
                        <span class="n">stopval</span> <span class="o">=</span> <span class="n">cellValue</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;TO&quot;</span><span class="p">)</span>
                        <span class="n">startTimeAll</span> <span class="o">=</span> <span class="n">cellValue</span><span class="p">[:</span><span class="n">stopval</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">colonval</span> <span class="o">=</span> <span class="n">startTimeAll</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;:&quot;</span><span class="p">)</span>
                        <span class="n">startTime1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">startTimeAll</span><span class="p">[:</span><span class="n">colonval</span><span class="p">])</span>
                        <span class="n">startTime2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">startTimeAll</span><span class="p">[</span><span class="n">colonval</span><span class="o">+</span><span class="mi">1</span><span class="p">:])</span>
                        <span class="n">signalData</span><span class="o">.</span><span class="n">signalTiming</span><span class="p">[</span><span class="n">strCso</span><span class="p">]</span><span class="o">.</span><span class="n">startTime</span> <span class="o">=</span> <span class="n">dta</span><span class="o">.</span><span class="n">Time</span><span class="p">(</span><span class="n">startTime1</span><span class="p">,</span> <span class="n">startTime2</span><span class="p">)</span>
                        <span class="n">endTimeAll</span> <span class="o">=</span> <span class="n">cellValue</span><span class="p">[</span><span class="n">stopval</span><span class="o">+</span><span class="mi">3</span><span class="p">:]</span>
                        <span class="n">colonval</span> <span class="o">=</span> <span class="n">endTimeAll</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;:&quot;</span><span class="p">)</span>
                        <span class="n">endTime1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">endTimeAll</span><span class="p">[:</span><span class="n">colonval</span><span class="p">])</span>
                        <span class="n">endTime2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">endTimeAll</span><span class="p">[</span><span class="n">colonval</span><span class="o">+</span><span class="mi">1</span><span class="p">:])</span>
                        <span class="n">signalData</span><span class="o">.</span><span class="n">signalTiming</span><span class="p">[</span><span class="n">strCso</span><span class="p">]</span><span class="o">.</span><span class="n">endTime</span> <span class="o">=</span> <span class="n">dta</span><span class="o">.</span><span class="n">Time</span><span class="p">(</span><span class="n">endTime1</span><span class="p">,</span> <span class="n">endTime2</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="s">&quot;:&quot;</span> <span class="ow">in</span> <span class="n">cellValue</span> <span class="ow">and</span> <span class="s">&quot;to&quot;</span> <span class="ow">in</span> <span class="n">cellValue</span><span class="p">:</span>
                        <span class="n">stopval</span> <span class="o">=</span> <span class="n">cellValue</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;to&quot;</span><span class="p">)</span>
                        <span class="n">startTimeAll</span> <span class="o">=</span> <span class="n">cellValue</span><span class="p">[:</span><span class="n">stopval</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">colonval</span> <span class="o">=</span> <span class="n">startTimeAll</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;:&quot;</span><span class="p">)</span>
                        <span class="n">startTime1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">startTimeAll</span><span class="p">[:</span><span class="n">colonval</span><span class="p">])</span>
                        <span class="n">startTime2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">startTimeAll</span><span class="p">[</span><span class="n">colonval</span><span class="o">+</span><span class="mi">1</span><span class="p">:])</span>
                        <span class="n">signalData</span><span class="o">.</span><span class="n">signalTiming</span><span class="p">[</span><span class="n">strCso</span><span class="p">]</span><span class="o">.</span><span class="n">startTime</span> <span class="o">=</span> <span class="n">dta</span><span class="o">.</span><span class="n">Time</span><span class="p">(</span><span class="n">startTime1</span><span class="p">,</span> <span class="n">startTime2</span><span class="p">)</span>
                        <span class="n">endTimeAll</span> <span class="o">=</span> <span class="n">cellValue</span><span class="p">[</span><span class="n">stopval</span><span class="o">+</span><span class="mi">3</span><span class="p">:]</span>
                        <span class="n">colonval</span> <span class="o">=</span> <span class="n">endTimeAll</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;:&quot;</span><span class="p">)</span>
                        <span class="n">endTime1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">endTimeAll</span><span class="p">[:</span><span class="n">colonval</span><span class="p">])</span>
                        <span class="n">endTime2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">endTimeAll</span><span class="p">[</span><span class="n">colonval</span><span class="o">+</span><span class="mi">1</span><span class="p">:])</span>
                        <span class="n">signalData</span><span class="o">.</span><span class="n">signalTiming</span><span class="p">[</span><span class="n">strCso</span><span class="p">]</span><span class="o">.</span><span class="n">endTime</span> <span class="o">=</span> <span class="n">dta</span><span class="o">.</span><span class="n">Time</span><span class="p">(</span><span class="n">endTime1</span><span class="p">,</span> <span class="n">endTime2</span><span class="p">)</span>

        <span class="c">#dta.DtaLogger.info(&quot;Operating times are from %s to %s for CSO %s&quot; % (signalData.signalTiming[strCso].startTime, signalData.signalTiming[strCso].endTime, strCso))</span>
        
    <span class="n">found</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="c"># search down rows from top left row for CYCLE keyword</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">7</span><span class="p">):</span>
        <span class="c"># search over starting at phase data column for CYCLE keyword</span>
        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">13</span><span class="p">):</span>
            <span class="n">keyword</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">sheet</span><span class="o">.</span><span class="n">cell_value</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">keyword</span> <span class="o">==</span> <span class="s">&quot;CYCLE&quot;</span><span class="p">:</span>  <span class="c">#find the row with the CYCLE keyword</span>
                <span class="n">found</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="n">colCycle</span> <span class="o">=</span> <span class="n">y</span>
                <span class="n">streetCell</span> <span class="o">=</span> <span class="n">findStreet</span><span class="p">(</span><span class="n">sheet</span><span class="p">,</span><span class="n">signalData</span><span class="o">.</span><span class="n">topLeftCell</span><span class="p">)</span>
                <span class="n">z</span> <span class="o">=</span> <span class="n">streetCell</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span> <span class="c">#search down until just before signal phasing section</span>
                    <span class="n">cso</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="mi">6</span><span class="p">):</span> <span class="c"># search six cells to the right of CYCLE column </span>
                        <span class="n">cellValue</span> <span class="o">=</span> <span class="n">sheet</span><span class="o">.</span><span class="n">cell_value</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">cellValue</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s">&quot;&quot;</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="k">if</span> <span class="n">cellValue</span><span class="p">:</span>
                            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cellValue</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
                                <span class="n">cellValue</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">cellValue</span><span class="p">))</span>
                            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cellValue</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                                <span class="n">cellValue</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">cellValue</span><span class="p">)</span>
                            <span class="n">cso</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cellValue</span><span class="p">)</span>
                    <span class="n">csosub</span> <span class="o">=</span> <span class="n">cso</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">strCso</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cso</span><span class="p">)</span>
                    <span class="n">strCsoSub</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">csosub</span><span class="p">)</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">strCso</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="c">#dta.DtaLogger.debug(&quot;I found CSO: %s&quot; % strCso)</span>
                    <span class="n">CSOMatch</span> <span class="o">=</span> <span class="bp">False</span>
                    <span class="c"># Syntax was changed so that only the first digit of the CSO is matched now instead of the whole number</span>
                    <span class="k">for</span> <span class="n">signalTimes</span> <span class="ow">in</span> <span class="n">signalData</span><span class="o">.</span><span class="n">signalTiming</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">signalTimes</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="n">strCsoSub</span><span class="p">:</span>
                            <span class="n">CSOMatch</span> <span class="o">=</span> <span class="bp">True</span>
                            <span class="n">strCso</span> <span class="o">=</span> <span class="n">signalTimes</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">CSOMatch</span><span class="p">:</span>
                        <span class="c"># Corrects for CSOs that are FREE or --- by assigning them to CSO of 111 which is All Other Times</span>
                        <span class="c"># or to any CSO that exists in the phasing if there is no 111</span>
                        <span class="k">if</span> <span class="n">strCsoSub</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s">&quot;F&quot;</span> <span class="ow">or</span> <span class="n">strCsoSub</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s">&quot;-&quot;</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">signalTimes</span> <span class="ow">in</span> <span class="n">signalData</span><span class="o">.</span><span class="n">signalTiming</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">signalTimes</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s">&quot;1&quot;</span><span class="p">:</span>
                                    <span class="n">CSOMatch</span> <span class="o">=</span> <span class="bp">True</span>
                                    <span class="n">strCso</span> <span class="o">=</span> <span class="n">signalTimes</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">CSOMatch</span> <span class="o">=</span> <span class="bp">True</span>
                                    <span class="n">strCso</span> <span class="o">=</span> <span class="n">signalTimes</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">timename</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">sheet</span><span class="o">.</span><span class="n">cell_value</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">y</span><span class="o">-</span><span class="mi">11</span><span class="p">))</span>
                            <span class="n">timename</span> <span class="o">=</span> <span class="n">timename</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                            <span class="n">timenamesub</span> <span class="o">=</span> <span class="n">timename</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span>
                            <span class="k">if</span> <span class="n">timenamesub</span> <span class="o">==</span> <span class="s">&quot;P&quot;</span><span class="p">:</span>
                                <span class="k">continue</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">CSOMatch</span><span class="p">:</span>
                        <span class="n">dta</span><span class="o">.</span><span class="n">DtaLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;ERROR CSO </span><span class="si">%s</span><span class="s"> does not exist in the timing section. Please manually correct the signal&quot;</span> <span class="o">%</span> <span class="n">strCso</span><span class="p">)</span>
                        <span class="k">continue</span>
                    <span class="n">setTimes</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">colCycle</span><span class="p">,</span><span class="n">sheet</span><span class="p">)</span>  <span class="c">#set the start and end times</span>
    <span class="k">if</span> <span class="n">found</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ParsingCardError</span><span class="p">(</span><span class="s">&quot;I cannot find start and end times&quot;</span><span class="p">)</span> 
</div>
<div class="viewcode-block" id="getSignalIntervalData"><a class="viewcode-back" href="../script_importExcelSignals.html#importExcelSignals.getSignalIntervalData">[docs]</a><span class="k">def</span> <span class="nf">getSignalIntervalData</span><span class="p">(</span><span class="n">sheet</span><span class="p">,</span> <span class="n">signalData</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Assigns the signal interval data from the supplied excel</span>
<span class="sd">    spreadsheet </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">signalData</span><span class="o">.</span><span class="n">sigInterCell</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">signalData</span><span class="o">.</span><span class="n">colPhaseData</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="c">#begin with the signal interval data</span>
    <span class="c"># Commented-out lines are from a previous version of the code.  The current version searches a set number of rows, whereas the other one would break once an empty line was hit.</span>
    <span class="c"># This meant that not all CSOs were read in, while having it read down 11 rows gets all of the CSOs for all signals.</span>
    <span class="n">startX</span><span class="p">,</span> <span class="n">startY</span> <span class="o">=</span> <span class="n">signalData</span><span class="o">.</span><span class="n">sigInterCell</span>
    <span class="c">#find the first enry</span>
    <span class="c">#i = startX</span>
    <span class="n">finishedReadingData</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="c">#while True:</span>
    <span class="c">#    i += 1</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span> <span class="p">(</span><span class="n">startX</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">startX</span><span class="o">+</span><span class="mi">11</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">sheet</span><span class="o">.</span><span class="n">cell_value</span><span class="p">(</span><span class="n">rowx</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">colx</span><span class="o">=</span><span class="n">startY</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="k">break</span>
        
        <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
            <span class="n">finishedReadingData</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">if</span> <span class="s">&quot;NOTE&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">or</span> <span class="s">&quot;*&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                <span class="k">break</span>
            <span class="n">row</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">startY</span><span class="p">,</span> <span class="n">signalData</span><span class="o">.</span><span class="n">colPhaseData</span><span class="p">):</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">sheet</span><span class="o">.</span><span class="n">cell_value</span><span class="p">(</span><span class="n">rowx</span><span class="o">=</span><span class="n">i</span><span class="p">,</span><span class="n">colx</span><span class="o">=</span><span class="n">j</span><span class="p">)</span>

                <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
                    <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    
            <span class="c">#you ought to have 3 values: CSO, CYCLE, OFFSET</span>
            <span class="c">#read the rest of the row</span>
            <span class="n">signalTiming</span> <span class="o">=</span> <span class="n">ExcelSignalTiming</span><span class="p">()</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">strCso</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">strCso</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">strCycle</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">strOffset</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">strCycle</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">strOffset</span> <span class="o">=</span> <span class="s">&quot;-&quot;</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">strCycle</span> <span class="o">=</span> <span class="s">&quot;-&quot;</span>
                <span class="n">strOffset</span> <span class="o">=</span> <span class="s">&quot;-&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ParsingCardError</span><span class="p">(</span><span class="s">&quot;I cannot parse the cso,cycle,offset from row </span><span class="si">%d</span><span class="s">:</span><span class="si">%s</span><span class="s">&quot;</span>
                                        <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">)))</span>              
            <span class="n">signalTiming</span><span class="o">.</span><span class="n">cso</span> <span class="o">=</span> <span class="n">strCso</span>
            <span class="k">if</span> <span class="n">strCso</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&quot;-&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">strCso</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">strCycle</span> <span class="o">!=</span> <span class="s">&quot;--&quot;</span><span class="p">:</span>
                <span class="n">signalTiming</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="n">strCso</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&quot;--&quot;</span><span class="p">):</span>
                    <span class="n">signalTiming</span><span class="o">.</span><span class="n">cycle</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">signalTiming</span><span class="o">.</span><span class="n">isActuated</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">signalTiming</span><span class="o">.</span><span class="n">cycle</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">strCycle</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">strCso</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&quot;--&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">strCso</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span> <span class="ow">and</span> <span class="n">strCycle</span> <span class="o">==</span> <span class="s">&quot;--&quot;</span><span class="p">:</span>
                <span class="n">signalTiming</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">signalTiming</span><span class="o">.</span><span class="n">cycle</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">strCycle</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">strCso</span> <span class="o">==</span> <span class="s">&quot;FREE&quot;</span> <span class="ow">or</span> <span class="n">strCso</span> <span class="o">==</span> <span class="s">&quot;free&quot;</span><span class="p">:</span>
                <span class="n">signalTiming</span><span class="o">.</span><span class="n">isActuated</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s">&quot;-&quot;</span> <span class="ow">in</span> <span class="n">strCycle</span><span class="p">:</span>
                        <span class="n">signalTiming</span><span class="o">.</span><span class="n">cycle</span> <span class="o">=</span> <span class="bp">None</span>
                        <span class="n">signalTiming</span><span class="o">.</span><span class="n">isActuated</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">signalTiming</span><span class="o">.</span><span class="n">cycle</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">strCycle</span><span class="p">)</span>    
                    <span class="n">signalTiming</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">strOffset</span><span class="p">)</span> <span class="k">if</span> <span class="s">&quot;-&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">strOffset</span>  <span class="k">else</span> <span class="mi">0</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">ParsingCardError</span><span class="p">(</span><span class="s">&quot;I could not parse the cso,cycle,offset from row </span><span class="si">%d</span><span class="s">:</span><span class="si">%s</span><span class="s">&quot;</span>
                                           <span class="s">&quot;, Error: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
                
            <span class="n">j</span> <span class="o">=</span> <span class="n">signalData</span><span class="o">.</span><span class="n">colPhaseData</span>
            <span class="n">timings</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">signalData</span><span class="o">.</span><span class="n">signalTiming</span><span class="p">[</span><span class="n">signalTiming</span><span class="o">.</span><span class="n">cso</span><span class="p">]</span> <span class="o">=</span> <span class="n">signalTiming</span>
            <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">sheet</span><span class="o">.</span><span class="n">cell_value</span><span class="p">(</span><span class="n">rowx</span><span class="o">=</span><span class="n">i</span><span class="p">,</span><span class="n">colx</span><span class="o">=</span><span class="n">j</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">signalData</span><span class="o">.</span><span class="n">lastColPhaseData</span><span class="p">:</span>
                        <span class="n">signalData</span><span class="o">.</span><span class="n">lastColPhaseData</span> <span class="o">=</span> <span class="n">j</span> <span class="o">-</span> <span class="mi">1</span>
                    <span class="n">signalData</span><span class="o">.</span><span class="n">sIntervals</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">row</span>
                    <span class="n">signalTiming</span><span class="o">.</span><span class="n">setPhaseTimes</span><span class="p">(</span><span class="n">timings</span><span class="p">)</span>
                    <span class="k">break</span>                    
                <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span> <span class="c"># I chanched this from value to value.strip()</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
                        <span class="k">raise</span> <span class="n">ParsingCardError</span><span class="p">(</span><span class="s">&quot;The signal intervals are not numbers &quot;</span>
                                               <span class="s">&quot;in row with CSO= </span><span class="si">%s</span><span class="s">. Problem reading: </span><span class="si">%s</span><span class="s"> at </span><span class="si">%d</span><span class="s">, </span><span class="si">%d</span><span class="s"> &quot;</span> 
                                               <span class="o">%</span> <span class="p">(</span><span class="n">strCso</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">))</span>
                                           
                    <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    <span class="n">timings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="c">#if you find an empty cell: stop reading </span>
                <span class="c"># and set the lastColPhaseData attribute </span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">signalData</span><span class="o">.</span><span class="n">lastColPhaseData</span><span class="p">:</span>
                        <span class="n">signalData</span><span class="o">.</span><span class="n">lastColPhaseData</span> <span class="o">=</span> <span class="n">j</span> <span class="o">-</span> <span class="mi">1</span>
                    <span class="n">signalData</span><span class="o">.</span><span class="n">sIntervals</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">row</span>
                    <span class="n">signalTiming</span><span class="o">.</span><span class="n">setPhaseTimes</span><span class="p">(</span><span class="n">timings</span><span class="p">)</span>
                    <span class="k">break</span>
                <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">continue</span></div>
<div class="viewcode-block" id="fillPhaseInfo"><a class="viewcode-back" href="../script_importExcelSignals.html#importExcelSignals.fillPhaseInfo">[docs]</a><span class="k">def</span> <span class="nf">fillPhaseInfo</span><span class="p">(</span><span class="n">phaseInfo</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The a list with the phase info for a movement group such as</span>
<span class="sd">       [&#39;&#39;, u&#39;G&#39;, &#39;&#39;, u&#39;Y&#39;, u&#39;R&#39;, &#39;&#39;, &#39;&#39;, &#39;&#39;, &#39;&#39;, &#39;&#39;, &#39;&#39;, &#39;&#39;]</span>
<span class="sd">       fill the empty strings with the state of the signal</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">phaseInfo</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">phaseInfo</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;&quot;</span> <span class="ow">and</span> <span class="n">phaseInfo</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&quot;&quot;</span><span class="p">:</span>
            <span class="n">phaseInfo</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">phaseInfo</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
            
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">phaseInfo</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">phaseInfo</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;&quot;</span> <span class="ow">and</span> <span class="n">phaseInfo</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&quot;&quot;</span><span class="p">:</span>
            <span class="n">phaseInfo</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">phaseInfo</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                </div>
<div class="viewcode-block" id="getPhasingData"><a class="viewcode-back" href="../script_importExcelSignals.html#importExcelSignals.getPhasingData">[docs]</a><span class="k">def</span> <span class="nf">getPhasingData</span><span class="p">(</span><span class="n">sheet</span><span class="p">,</span> <span class="n">signalData</span><span class="p">):</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">signalData</span><span class="o">.</span><span class="n">phaseSeqCell</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ParsingCardError</span><span class="p">(</span><span class="s">&quot;I cannot parse its phasing data1.&quot;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">signalData</span><span class="o">.</span><span class="n">sigInterCell</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ParsingCardError</span><span class="p">(</span><span class="s">&quot;I cannot parse its phasing data2.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">signalData</span><span class="o">.</span><span class="n">colPhaseData</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ParsingCardError</span><span class="p">(</span><span class="s">&quot;I cannot parse its phasing data3.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">signalData</span><span class="o">.</span><span class="n">lastColPhaseData</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ParsingCardError</span><span class="p">(</span><span class="s">&quot;I cannot parse its phasing data4.&quot;</span><span class="p">)</span>        

    <span class="n">startX</span><span class="p">,</span> <span class="n">startY</span> <span class="o">=</span> <span class="n">signalData</span><span class="o">.</span><span class="n">phaseSeqCell</span> 

    <span class="n">endX</span><span class="p">,</span> <span class="n">endY</span> <span class="o">=</span> <span class="n">signalData</span><span class="o">.</span><span class="n">sigInterCell</span>

    <span class="n">movementIndex</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">phasingData</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">movementNames</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">intervalStateGreen</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;G&quot;</span><span class="p">,</span> <span class="s">&quot;G+G&quot;</span><span class="p">,</span> <span class="s">&quot;G*&quot;</span><span class="p">,</span> <span class="s">&quot;G G&quot;</span><span class="p">,</span> <span class="s">&quot;FY&quot;</span><span class="p">,</span> <span class="s">&quot;F&quot;</span><span class="p">,</span> <span class="s">&quot;G+F&quot;</span><span class="p">,</span> <span class="s">&quot;U&quot;</span><span class="p">,</span> <span class="s">&quot;T&quot;</span><span class="p">,</span> <span class="s">&quot;G + G&quot;</span><span class="p">,</span> <span class="s">&quot;G + F&quot;</span><span class="p">,</span> <span class="s">&quot;ON&quot;</span><span class="p">]</span>
    <span class="n">intervalStateYellow</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;Y&quot;</span><span class="p">,</span> <span class="s">&quot;SY&quot;</span><span class="p">]</span>
    <span class="n">intervalStateRed</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;R&quot;</span><span class="p">,</span> <span class="s">&quot;RH&quot;</span><span class="p">,</span> <span class="s">&quot;OFF&quot;</span><span class="p">,</span> <span class="s">&quot;FR&quot;</span><span class="p">]</span>
    <span class="n">intervalStateBlank</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;&quot;</span><span class="p">]</span>
    <span class="n">intervalStateValid</span> <span class="o">=</span> <span class="n">intervalStateGreen</span> <span class="o">+</span> <span class="n">intervalStateYellow</span> <span class="o">+</span> \
        <span class="n">intervalStateRed</span> <span class="o">+</span> <span class="n">intervalStateBlank</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">startX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">endX</span><span class="p">):</span>
        <span class="n">groupMovement</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">sheet</span><span class="o">.</span><span class="n">cell_value</span><span class="p">(</span><span class="n">rowx</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">colx</span><span class="o">=</span><span class="n">startY</span><span class="p">))</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
                               
        <span class="k">if</span> <span class="n">groupMovement</span> <span class="o">==</span> <span class="s">&quot;&quot;</span> <span class="ow">or</span> <span class="s">&quot;PEDS &quot;</span> <span class="ow">in</span> <span class="n">groupMovement</span> <span class="ow">or</span> <span class="s">&quot;PED &quot;</span> <span class="ow">in</span> <span class="n">groupMovement</span> \
                <span class="ow">or</span> <span class="s">&quot;XING &quot;</span> <span class="ow">in</span> <span class="n">groupMovement</span> <span class="ow">or</span> <span class="s">&quot;MUNI &quot;</span> <span class="ow">in</span> <span class="n">groupMovement</span> <span class="ow">or</span> \
                <span class="s">&quot;TRAIN &quot;</span> <span class="ow">in</span> <span class="n">groupMovement</span> <span class="ow">or</span> <span class="s">&quot;FLASHING &quot;</span> <span class="ow">in</span> <span class="n">groupMovement</span> <span class="ow">or</span> \
                <span class="n">groupMovement</span> <span class="o">==</span> <span class="s">&quot;MUNI&quot;</span> <span class="ow">or</span> <span class="s">&quot; MUNI&quot;</span> <span class="ow">in</span> <span class="n">groupMovement</span> <span class="ow">or</span> <span class="s">&quot;RAIL&quot;</span> <span class="ow">in</span> <span class="n">groupMovement</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c">#read the row of phasing states </span>
            <span class="n">singleMovementData</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">allIntervalStatesValid</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">signalData</span><span class="o">.</span><span class="n">colPhaseData</span><span class="p">,</span> <span class="n">signalData</span><span class="o">.</span><span class="n">lastColPhaseData</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">intervalState</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">sheet</span><span class="o">.</span><span class="n">cell_value</span><span class="p">(</span><span class="n">rowx</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">colx</span><span class="o">=</span><span class="n">j</span><span class="p">))</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">intervalState</span> <span class="o">==</span> <span class="s">&quot;&quot;</span><span class="p">:</span>
                    <span class="n">singleMovementData</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">intervalState</span> <span class="ow">in</span> <span class="n">intervalStateGreen</span><span class="p">:</span>
                    <span class="n">singleMovementData</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;G&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">intervalState</span> <span class="ow">in</span> <span class="n">intervalStateYellow</span><span class="p">:</span>
                    <span class="n">singleMovementData</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;Y&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">intervalState</span> <span class="ow">in</span> <span class="n">intervalStateRed</span> <span class="ow">or</span> <span class="s">&quot;-R-&quot;</span> <span class="ow">in</span> <span class="n">intervalStateRed</span><span class="p">:</span>
                    <span class="n">singleMovementData</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;R&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">allIntervalStatesValid</span> <span class="o">=</span> <span class="bp">False</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">allIntervalStatesValid</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">singleMovementData</span> <span class="o">==</span> <span class="p">[</span><span class="s">&quot;&quot;</span><span class="p">,]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">singleMovementData</span><span class="p">):</span>
                <span class="k">continue</span>

        <span class="nb">setattr</span><span class="p">(</span><span class="n">signalData</span><span class="p">,</span> <span class="s">&quot;gMov</span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">movementIndex</span><span class="p">,</span> <span class="n">groupMovement</span><span class="p">)</span>
        <span class="n">movementIndex</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">movementNames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">groupMovement</span><span class="p">)</span>

        <span class="n">phasingData</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">singleMovementData</span><span class="p">)</span>        
    
    <span class="k">if</span> <span class="n">phasingData</span> <span class="o">==</span> <span class="p">[]:</span>
        <span class="k">raise</span> <span class="n">ParsingCardError</span><span class="p">(</span><span class="s">&quot;I cannot parse its phasing data&quot;</span><span class="p">)</span>
    <span class="n">numIntervals</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">phasingData</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">numIntervals</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ParsingCardError</span><span class="p">(</span><span class="s">&quot;I cannot parse its phasing data. &quot;</span>
                               <span class="s">&quot;The number of phase intervals is zero&quot;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">phasingData</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ParsingCardError</span><span class="p">(</span><span class="s">&quot;Signal has less than two group movements&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">phasingData</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">phasingData</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">phasingData</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">phasingData</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]):</span>
                <span class="k">raise</span> <span class="n">ParsingCardError</span><span class="p">(</span><span class="s">&quot;I cannot parse its phasing data. &quot;</span>
                               <span class="s">&quot;Different number of phasing steps for &quot;</span>
                                       <span class="s">&quot;different phasing movements&quot;</span><span class="p">)</span>


    <span class="k">if</span> <span class="n">signalData</span><span class="o">.</span><span class="n">getNumTimeIntervals</span><span class="p">()</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">phasingData</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">raise</span> <span class="n">ParsingCardError</span><span class="p">(</span><span class="s">&quot;The number of phase states </span><span class="si">%d</span><span class="s"> is not the same &quot;</span>
                               <span class="s">&quot;with the number of its signal intervals </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> 
                               <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">phasingData</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> 
                                <span class="n">signalData</span><span class="o">.</span><span class="n">getNumTimeIntervals</span><span class="p">()))</span>

    <span class="n">ma</span> <span class="o">=</span> <span class="n">MultiArray</span><span class="p">(</span><span class="s">&quot;S1&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">movementNames</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">numIntervals</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)])</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">movName</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ma</span><span class="o">.</span><span class="n">getElementsOfDimention</span><span class="p">(</span><span class="mi">0</span><span class="p">)):</span>
        <span class="n">fillPhaseInfo</span><span class="p">(</span><span class="n">phasingData</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">numIntervals</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">intervalState</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">phasingData</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">intervalState</span> <span class="o">==</span> <span class="s">&quot;G&quot;</span><span class="p">:</span>
                <span class="n">ma</span><span class="p">[</span><span class="n">movName</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;G&quot;</span> <span class="c"># GREEN</span>
            <span class="k">elif</span> <span class="n">intervalState</span> <span class="o">==</span> <span class="s">&quot;Y&quot;</span><span class="p">:</span>
                <span class="n">ma</span><span class="p">[</span><span class="n">movName</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Y&quot;</span> <span class="c"># YELLOW</span>
            <span class="k">elif</span> <span class="n">intervalState</span> <span class="o">==</span> <span class="s">&quot;R&quot;</span><span class="p">:</span>
                <span class="n">ma</span><span class="p">[</span><span class="n">movName</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;R&quot;</span> <span class="c">#RED</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ParsingCardError</span><span class="p">(</span><span class="s">&quot;Group movement </span><span class="se">\t</span><span class="si">%s</span><span class="se">\t</span><span class="s">. I cannot interpret &quot;</span>
                                       <span class="s">&quot;the phase status </span><span class="se">\t</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">movName</span><span class="p">,</span> <span class="n">intervalState</span><span class="p">))</span>
                
    <span class="n">signalData</span><span class="o">.</span><span class="n">phasingData</span> <span class="o">=</span> <span class="n">ma</span>
</div>
<div class="viewcode-block" id="extractStreetNames"><a class="viewcode-back" href="../script_importExcelSignals.html#importExcelSignals.extractStreetNames">[docs]</a><span class="k">def</span> <span class="nf">extractStreetNames</span><span class="p">(</span><span class="n">intersection</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Split the Excel intersection string to two or more streetNames&quot;&quot;&quot;</span>

    <span class="n">intersection</span> <span class="o">=</span> <span class="n">intersection</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
    <span class="n">regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&quot;,| AND|\&amp;|\@|\ AT|\/&quot;</span><span class="p">)</span>
    <span class="n">streetNames</span> <span class="o">=</span> <span class="n">regex</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">intersection</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">streetNames</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c">#log the error</span>
        <span class="k">pass</span>
    <span class="n">result</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">name</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">streetNames</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">result</span>
</div>
<div class="viewcode-block" id="cleanStreetName"><a class="viewcode-back" href="../script_importExcelSignals.html#importExcelSignals.cleanStreetName">[docs]</a><span class="k">def</span> <span class="nf">cleanStreetName</span><span class="p">(</span><span class="n">streetName</span><span class="p">):</span>

    <span class="n">corrections</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;TWELFTH&quot;</span><span class="p">:</span><span class="s">&quot;12TH&quot;</span><span class="p">,</span> 
                   <span class="s">&quot;ELEVENTH&quot;</span><span class="p">:</span><span class="s">&quot;11TH&quot;</span><span class="p">,</span>
                   <span class="s">&quot;TENTH&quot;</span><span class="p">:</span><span class="s">&quot;10TH&quot;</span><span class="p">,</span>
                   <span class="s">&quot;NINTH&quot;</span><span class="p">:</span><span class="s">&quot;9TH&quot;</span><span class="p">,</span>
                   <span class="s">&quot;EIGHTH&quot;</span><span class="p">:</span><span class="s">&quot;8TH&quot;</span><span class="p">,</span>
                   <span class="s">&quot;SEVENTH&quot;</span><span class="p">:</span><span class="s">&quot;7TH&quot;</span><span class="p">,</span>
                   <span class="s">&quot;SIXTH&quot;</span><span class="p">:</span><span class="s">&quot;6TH&quot;</span><span class="p">,</span>
                   <span class="s">&quot;FIFTH&quot;</span><span class="p">:</span><span class="s">&quot;5TH&quot;</span><span class="p">,</span>
                   <span class="s">&quot;FOURTH&quot;</span><span class="p">:</span><span class="s">&quot;4TH&quot;</span><span class="p">,</span>
                   <span class="s">&quot;THIRD&quot;</span><span class="p">:</span><span class="s">&quot;3RD&quot;</span><span class="p">,</span>
                   <span class="s">&quot;SECOND&quot;</span><span class="p">:</span><span class="s">&quot;2ND&quot;</span><span class="p">,</span>
                   <span class="s">&quot;FIRST&quot;</span><span class="p">:</span><span class="s">&quot;1ST&quot;</span><span class="p">,</span>
                   <span class="s">&quot;O&#39;FARRELL&quot;</span><span class="p">:</span><span class="s">&quot;O FARRELL&quot;</span><span class="p">,</span>
                   <span class="s">&quot;3RDREET&quot;</span><span class="p">:</span><span class="s">&quot;3RD&quot;</span><span class="p">,</span>
                   <span class="s">&quot;EMBARCADERO/KING&quot;</span><span class="p">:</span><span class="s">&quot;THE EMBARCADERO&quot;</span><span class="p">,</span>
                   <span class="s">&quot;VAN NESSNUE&quot;</span><span class="p">:</span><span class="s">&quot;VAN NESS&quot;</span><span class="p">,</span>
                   <span class="s">&quot;3RD #3&quot;</span><span class="p">:</span><span class="s">&quot;3RD&quot;</span><span class="p">,</span>
                   <span class="s">&quot;BAYSHORE #3&quot;</span><span class="p">:</span><span class="s">&quot;BAYSHORE&quot;</span><span class="p">,</span>
                   <span class="s">&quot;09TH&quot;</span><span class="p">:</span><span class="s">&quot;9TH&quot;</span><span class="p">,</span>
                   <span class="s">&quot;08TH&quot;</span><span class="p">:</span><span class="s">&quot;8TH&quot;</span><span class="p">,</span>
                   <span class="s">&quot;07TH&quot;</span><span class="p">:</span><span class="s">&quot;7TH&quot;</span><span class="p">,</span>
                   <span class="s">&quot;06TH&quot;</span><span class="p">:</span><span class="s">&quot;6TH&quot;</span><span class="p">,</span>
                   <span class="s">&quot;05TH&quot;</span><span class="p">:</span><span class="s">&quot;5TH&quot;</span><span class="p">,</span>
                   <span class="s">&quot;04TH&quot;</span><span class="p">:</span><span class="s">&quot;4TH&quot;</span><span class="p">,</span>
                   <span class="s">&quot;03RD&quot;</span><span class="p">:</span><span class="s">&quot;3RD&quot;</span><span class="p">,</span>
                   <span class="s">&quot;02ND&quot;</span><span class="p">:</span><span class="s">&quot;2ND&quot;</span><span class="p">,</span>
                   <span class="s">&quot;01ST&quot;</span><span class="p">:</span><span class="s">&quot;1ST&quot;</span><span class="p">}</span>


    <span class="n">itemsToRemove</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot; STREETS&quot;</span><span class="p">,</span>
                     <span class="s">&quot; STREET&quot;</span><span class="p">,</span>
                     <span class="s">&quot; STS.&quot;</span><span class="p">,</span>
                     <span class="s">&quot; STS&quot;</span><span class="p">,</span>
                     <span class="s">&quot; ST.&quot;</span><span class="p">,</span>
                     <span class="s">&quot; ST&quot;</span><span class="p">,</span>
                     <span class="s">&quot; ROAD&quot;</span><span class="p">,</span>
                     <span class="s">&quot; RD.&quot;</span><span class="p">,</span>
                     <span class="s">&quot; RD&quot;</span><span class="p">,</span>
                     <span class="s">&quot; AVENUE&quot;</span><span class="p">,</span>
                     <span class="s">&quot; AVE.&quot;</span><span class="p">,</span>
                     <span class="s">&quot; AVES&quot;</span><span class="p">,</span>
                     <span class="s">&quot; AVE&quot;</span><span class="p">,</span>
                     <span class="s">&quot; BLVD.&quot;</span><span class="p">,</span>
                     <span class="s">&quot; BLVD&quot;</span><span class="p">,</span>
                     <span class="s">&quot; BOULEVARD&quot;</span><span class="p">,</span>
                     <span class="s">&quot;MASTER:&quot;</span><span class="p">,</span>
                     <span class="s">&quot; DRIVE&quot;</span><span class="p">,</span>
                     <span class="s">&quot; DR.&quot;</span><span class="p">,</span>
                     <span class="s">&quot; WAY&quot;</span><span class="p">,</span>
                     <span class="s">&quot; WY&quot;</span><span class="p">,</span>
                     <span class="s">&quot; CT&quot;</span><span class="p">,</span>
                     <span class="s">&quot; TERR&quot;</span><span class="p">,</span>
                     <span class="s">&quot; HWY&quot;</span><span class="p">]</span>

    <span class="n">newStreetName</span> <span class="o">=</span> <span class="n">streetName</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">wrongName</span><span class="p">,</span> <span class="n">rightName</span> <span class="ow">in</span> <span class="n">corrections</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">wrongName</span> <span class="ow">in</span> <span class="n">streetName</span><span class="p">:</span>
            <span class="n">newStreetName</span> <span class="o">=</span> <span class="n">streetName</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">wrongName</span><span class="p">,</span> <span class="n">rightName</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">streetName</span> <span class="o">==</span> <span class="s">&#39;EMBARCADERO&#39;</span><span class="p">:</span>
            <span class="n">newStreetName</span> <span class="o">=</span> <span class="s">&quot;THE EMBARCADERO&quot;</span>
        <span class="k">if</span> <span class="n">streetName</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&quot; DR&quot;</span><span class="p">):</span>
            <span class="n">newStreetName</span> <span class="o">=</span> <span class="n">streetName</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">streetName</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&quot; AV&quot;</span><span class="p">):</span>
            <span class="n">newStreetName</span> <span class="o">=</span> <span class="n">streetName</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>
        <span class="k">if</span> <span class="s">&quot; TO &quot;</span> <span class="ow">in</span> <span class="n">streetName</span><span class="p">:</span>
            <span class="n">cutOff</span> <span class="o">=</span> <span class="n">streetName</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot; TO &quot;</span><span class="p">)</span>
            <span class="n">newStreetName</span> <span class="o">=</span> <span class="n">streetName</span><span class="p">[:</span><span class="n">cutOff</span><span class="p">]</span>
            

    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">itemsToRemove</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">newStreetName</span><span class="p">:</span>
            <span class="n">newStreetName</span> <span class="o">=</span> <span class="n">newStreetName</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">newStreetName</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    
</div>
<div class="viewcode-block" id="cleanStreetNames"><a class="viewcode-back" href="../script_importExcelSignals.html#importExcelSignals.cleanStreetNames">[docs]</a><span class="k">def</span> <span class="nf">cleanStreetNames</span><span class="p">(</span><span class="n">streetNames</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Accept street names as a list and return a list </span>
<span class="sd">    with the cleaned street names&quot;&quot;&quot;</span>
    
    <span class="n">newStreetNames</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">cleanStreetName</span><span class="p">,</span> <span class="n">streetNames</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">newStreetNames</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">newStreetNames</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;&quot;</span><span class="p">:</span>
        <span class="n">newStreetNames</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">newStreetNames</span>
</div>
<div class="viewcode-block" id="parseExcelCardFile"><a class="viewcode-back" href="../script_importExcelSignals.html#importExcelSignals.parseExcelCardFile">[docs]</a><span class="k">def</span> <span class="nf">parseExcelCardFile</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">fileName</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reads the excel file, parses its information and returns</span>
<span class="sd">    as a :py:class:`SignalData` object.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sd</span> <span class="o">=</span> <span class="n">SignalData</span><span class="p">()</span>
    <span class="n">sd</span><span class="o">.</span><span class="n">fileName</span> <span class="o">=</span> <span class="n">fileName</span>
    <span class="n">book</span> <span class="o">=</span> <span class="n">xlrd</span><span class="o">.</span><span class="n">open_workbook</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">fileName</span><span class="p">))</span>
    <span class="n">sheet</span> <span class="o">=</span> <span class="n">book</span><span class="o">.</span><span class="n">sheet_by_index</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        
    <span class="n">sd</span><span class="o">.</span><span class="n">topLeftCell</span> <span class="o">=</span> <span class="n">findTopLeftCell</span><span class="p">(</span><span class="n">sheet</span><span class="p">)</span>
    <span class="n">sd</span><span class="o">.</span><span class="n">iName</span> <span class="o">=</span> <span class="n">getIntersectionName</span><span class="p">(</span><span class="n">sheet</span><span class="p">,</span> <span class="n">sd</span><span class="o">.</span><span class="n">topLeftCell</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">sd</span><span class="o">.</span><span class="n">phaseSeqCell</span> <span class="o">=</span> <span class="n">findStreet</span><span class="p">(</span><span class="n">sheet</span><span class="p">,</span> <span class="n">sd</span><span class="o">.</span><span class="n">topLeftCell</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">ParsingCardError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Unable to find the start of the phasing section. filename </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">fileName</span>
        <span class="k">raise</span> <span class="n">ParsingCardError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="n">sd</span><span class="o">.</span><span class="n">pedPhaseCell</span> <span class="o">=</span> <span class="n">findPedestrianPhase</span><span class="p">(</span><span class="n">sheet</span><span class="p">,</span> <span class="n">sd</span><span class="o">.</span><span class="n">topLeftCell</span><span class="p">)</span>
    <span class="n">sd</span><span class="o">.</span><span class="n">sigInterCell</span> <span class="o">=</span> <span class="n">findSignalIntervals</span><span class="p">(</span><span class="n">sheet</span><span class="p">,</span> <span class="n">sd</span><span class="o">.</span><span class="n">topLeftCell</span><span class="p">)</span>    
    <span class="n">getFirstColumnOfPhasingData</span><span class="p">(</span><span class="n">sheet</span><span class="p">,</span> <span class="n">sd</span><span class="p">)</span>
    <span class="n">getSignalIntervalData</span><span class="p">(</span><span class="n">sheet</span><span class="p">,</span> <span class="n">sd</span><span class="p">)</span>

    <span class="n">getOperationTimes</span><span class="p">(</span><span class="n">sheet</span><span class="p">,</span> <span class="n">sd</span><span class="p">)</span>

    <span class="n">getPhasingData</span><span class="p">(</span><span class="n">sheet</span><span class="p">,</span> <span class="n">sd</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sd</span>

</div>
<div class="viewcode-block" id="parseExcelCardsToSignalObjects"><a class="viewcode-back" href="../script_importExcelSignals.html#importExcelSignals.parseExcelCardsToSignalObjects">[docs]</a><span class="k">def</span> <span class="nf">parseExcelCardsToSignalObjects</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span><span class="n">fileName</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reads the raw excel cards, extracts all the relevant information, instantiates </span>
<span class="sd">    for each excel file an object called SignalData and stores the information</span>
<span class="sd">    and then pickles all the signal data objects into a file named: </span>

<span class="sd">    excelCards.pkl</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">fileName</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&quot;xls&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="k">if</span> <span class="n">fileName</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;System&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">sd</span> <span class="o">=</span> <span class="n">parseExcelCardFile</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">fileName</span><span class="p">)</span>

    <span class="k">except</span> <span class="n">ParsingCardError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">dta</span><span class="o">.</span><span class="n">DtaLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Error parsing </span><span class="si">%-40s</span><span class="s">: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fileName</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
        <span class="n">problemCards</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sd</span><span class="p">)</span>
        <span class="n">sd</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="n">e</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">excelCards</span> <span class="o">=</span> <span class="n">sd</span>

    <span class="k">return</span> <span class="n">excelCards</span>
</div>
<div class="viewcode-block" id="mapStreetNamesForManuallyMappedNodes"><a class="viewcode-back" href="../script_importExcelSignals.html#importExcelSignals.mapStreetNamesForManuallyMappedNodes">[docs]</a><span class="k">def</span> <span class="nf">mapStreetNamesForManuallyMappedNodes</span><span class="p">(</span><span class="n">network</span><span class="p">,</span> <span class="n">cards</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function maps street names for the nodes that have been manually mapped    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">CUTOFF</span> <span class="o">=</span> <span class="mf">0.7</span> <span class="c"># this parameter controls how close the strings need be</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">card</span> <span class="ow">in</span> <span class="n">cards</span><span class="p">:</span>        
        <span class="n">streetNames</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">streetNames</span>        
        <span class="n">node</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">getNodeForId</span><span class="p">(</span><span class="n">card</span><span class="o">.</span><span class="n">mappedNodeId</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">getStreetNames</span><span class="p">(</span><span class="n">incoming</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">outgoing</span><span class="o">=</span><span class="bp">False</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">streetNames</span><span class="p">):</span>
            <span class="k">print</span> <span class="n">card</span><span class="o">.</span><span class="n">fileName</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">.</span><span class="n">mappedNodeId</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">getStreetNames</span><span class="p">(),</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">streetNames</span>
            <span class="k">continue</span>
            
        <span class="n">baseStreetNames</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">getStreetNames</span><span class="p">(</span><span class="n">incoming</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">outgoing</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">bName</span><span class="p">,</span> <span class="n">mName</span> <span class="ow">in</span> <span class="n">izip</span><span class="p">(</span><span class="n">baseStreetNames</span><span class="p">,</span> <span class="n">streetNames</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">difflib</span><span class="o">.</span><span class="n">get_close_matches</span><span class="p">(</span><span class="n">bName</span><span class="p">,</span> <span class="p">[</span><span class="n">mName</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">CUTOFF</span><span class="p">):</span>
                <span class="k">print</span> <span class="n">card</span><span class="o">.</span><span class="n">fileName</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">.</span><span class="n">mappedNodeId</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">getStreetNames</span><span class="p">(),</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">streetNames</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bName</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mName</span>
                <span class="k">break</span>
            <span class="n">card</span><span class="o">.</span><span class="n">mappedStreet</span><span class="p">[</span><span class="n">mName</span><span class="p">]</span> <span class="o">=</span> <span class="n">bName</span>            
        <span class="k">else</span><span class="p">:</span>
            <span class="n">card</span><span class="o">.</span><span class="n">mappedNodeName</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">getName</span><span class="p">()</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">card</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>
</div>
<div class="viewcode-block" id="findNodeWithSameStreetNames"><a class="viewcode-back" href="../script_importExcelSignals.html#importExcelSignals.findNodeWithSameStreetNames">[docs]</a><span class="k">def</span> <span class="nf">findNodeWithSameStreetNames</span><span class="p">(</span><span class="n">network</span><span class="p">,</span> <span class="n">excelCard</span><span class="p">,</span> <span class="n">CUTOFF</span><span class="p">,</span> <span class="n">mappedNodes</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a :py:class:`dta.DynameqNetwork` instance, *network*, and </span>
<span class="sd">    an instance of ?, *excelCard*,</span>
<span class="sd">    looks for the :py:class:`dta.RoadNode` instance in the *network* with matching</span>
<span class="sd">    streetnames to the excelCard.streetNames</span>
<span class="sd">    </span>
<span class="sd">    Returns True if a match is found, and sets:</span>
<span class="sd">      * excelCard.mappedStreet</span>
<span class="sd">      * excelCard.mappedNodeName</span>
<span class="sd">      * excelCard.mappedNodeId</span>
<span class="sd">      </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">streetNames</span> <span class="o">=</span> <span class="n">excelCard</span><span class="o">.</span><span class="n">streetNames</span>
    <span class="n">dta</span><span class="o">.</span><span class="n">DtaLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Street names for mapping are </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">streetNames</span><span class="p">)</span>     

    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">network</span><span class="o">.</span><span class="n">iterRoadNodes</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">getId</span><span class="p">()</span> <span class="ow">in</span> <span class="n">mappedNodes</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">continue</span>
        
        <span class="n">baseStreetNames</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">getStreetNames</span><span class="p">(</span><span class="n">incoming</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">outgoing</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">baseStreetNames_cleaned</span> <span class="o">=</span> <span class="p">[</span><span class="n">cleanStreetName</span><span class="p">(</span><span class="n">bs</span><span class="p">)</span> <span class="k">for</span> <span class="n">bs</span> <span class="ow">in</span> <span class="n">baseStreetNames</span><span class="p">]</span>
        <span class="n">baseStreetNames_cleaned</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">baseStreetNames_cleaned</span><span class="p">)</span>
        <span class="n">baseStreetNames_cleaned</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">baseStreetNames_cleaned</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">baseStreetNames_cleaned</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">streetNames</span><span class="p">):</span>
            <span class="c">#dta.DtaLogger.error(&quot;Street names different lengths&quot;)</span>
            <span class="k">continue</span>
        
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">baseStreetNames_cleaned</span><span class="p">)):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">difflib</span><span class="o">.</span><span class="n">get_close_matches</span><span class="p">(</span><span class="n">baseStreetNames_cleaned</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="p">[</span><span class="n">streetNames</span><span class="p">[</span><span class="n">idx</span><span class="p">]],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">CUTOFF</span><span class="p">):</span>
                <span class="k">break</span>

            <span class="c">## The node selection for this intersection has to be hard-coded since there are two intersections between the same streets and one does</span>
            <span class="c">## not have the turns that are included in the signal phases</span>
            <span class="k">elif</span> <span class="n">streetNames</span> <span class="o">==</span> <span class="p">[</span><span class="s">&#39;19TH&#39;</span><span class="p">,</span> <span class="s">&#39;WINSTON&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">getId</span><span class="p">()</span><span class="o">!=</span> <span class="mi">23069</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">elif</span> <span class="n">streetNames</span> <span class="o">==</span> <span class="p">[</span><span class="s">&#39;23RD&#39;</span><span class="p">,</span> <span class="s">&#39;POTRERO&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">getId</span><span class="p">()</span><span class="o">!=</span> <span class="mi">23962</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">elif</span> <span class="n">streetNames</span> <span class="o">==</span> <span class="p">[</span><span class="s">&#39;25TH&#39;</span><span class="p">,</span> <span class="s">&#39;POTRERO&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">getId</span><span class="p">()</span><span class="o">!=</span> <span class="mi">23952</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">elif</span> <span class="n">streetNames</span> <span class="o">==</span> <span class="p">[</span><span class="s">&#39;DONAHUE&#39;</span><span class="p">,</span> <span class="s">&#39;INNES&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">getId</span><span class="p">()</span><span class="o">!=</span> <span class="mi">51690</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">excelCard</span><span class="o">.</span><span class="n">mappedStreet</span><span class="p">[</span><span class="n">streetNames</span><span class="p">[</span><span class="n">idx</span><span class="p">]]</span> <span class="o">=</span> <span class="n">baseStreetNames_cleaned</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
       
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mappedNodes</span><span class="p">[</span><span class="n">excelCard</span><span class="o">.</span><span class="n">iiName</span><span class="p">]</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">getId</span><span class="p">()</span>
            <span class="n">excelCard</span><span class="o">.</span><span class="n">mappedNodeName</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">getName</span><span class="p">()</span>
            <span class="n">excelCard</span><span class="o">.</span><span class="n">mappedNodeId</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">getId</span><span class="p">()</span>

            <span class="k">return</span> <span class="bp">True</span>
    <span class="k">return</span> <span class="bp">False</span>
</div>
<div class="viewcode-block" id="groupMovementToTurnType"><a class="viewcode-back" href="../script_importExcelSignals.html#importExcelSignals.groupMovementToTurnType">[docs]</a><span class="k">def</span> <span class="nf">groupMovementToTurnType</span><span class="p">(</span><span class="n">gMovName</span><span class="p">,</span> <span class="n">addRightToThru</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given *gMovName*, which is the string from the Excel file representing a movement (e.g. ``OTIS SBLT`` or ``17TH ST. W/B THRU``),</span>
<span class="sd">    returns a list of relevant turntypes corresponding to the :py:meth:`Movement.getTurnType` method.</span>
<span class="sd">    </span>
<span class="sd">    Pass *addRightToThru* if you want the through movements to come with right turns automatically.</span>

<span class="sd">    the function is being called by mapGroupMovments</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c">#todo ends with LT</span>
    <span class="n">leftTurnIndicators</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;LT&#39;S&quot;</span><span class="p">,</span><span class="s">&quot;-L&quot;</span><span class="p">,</span> <span class="s">&quot;WB-L&quot;</span><span class="p">,</span><span class="s">&quot;EB-L&quot;</span><span class="p">,</span><span class="s">&quot;SB-L&quot;</span><span class="p">,</span><span class="s">&quot;NB-L&quot;</span><span class="p">,</span><span class="s">&quot;LEFT TURN&quot;</span><span class="p">,</span> <span class="s">&quot; LT&quot;</span><span class="p">,</span> <span class="s">&quot;NBLT&quot;</span><span class="p">,</span> <span class="s">&quot;SBLT&quot;</span><span class="p">,</span> <span class="s">&quot;WBLT&quot;</span><span class="p">,</span> <span class="s">&quot;EBLT&quot;</span><span class="p">,</span><span class="s">&quot;(NBLT)&quot;</span><span class="p">,</span> <span class="s">&quot;(SBLT)&quot;</span><span class="p">,</span> <span class="s">&quot;(WBLT)&quot;</span><span class="p">,</span> <span class="s">&quot;(EBLT)&quot;</span><span class="p">]</span>
    <span class="n">rightTurnIndicators</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;RIGHT TURN&quot;</span><span class="p">,</span> <span class="s">&quot;BRT&quot;</span><span class="p">,</span> <span class="s">&quot; RT&quot;</span><span class="p">]</span>
    <span class="n">thruTurnIndicators</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot; THRU&quot;</span><span class="p">,</span> <span class="s">&quot; THROUGH&quot;</span><span class="p">,</span> <span class="s">&quot;(THRU)&quot;</span><span class="p">]</span>

    <span class="n">indicators</span> <span class="o">=</span> <span class="p">{</span><span class="n">TURN_LEFT</span><span class="p">:</span><span class="n">leftTurnIndicators</span><span class="p">,</span> <span class="n">TURN_THRU</span><span class="p">:</span><span class="n">thruTurnIndicators</span><span class="p">,</span> <span class="n">TURN_RIGHT</span><span class="p">:</span><span class="n">rightTurnIndicators</span><span class="p">}</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">thruadded</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">movadded</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">for</span> <span class="nb">dir</span><span class="p">,</span> <span class="n">dirIndicators</span> <span class="ow">in</span> <span class="n">indicators</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">indicator</span> <span class="ow">in</span> <span class="n">dirIndicators</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">indicator</span> <span class="ow">in</span> <span class="n">gMovName</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">dir</span><span class="p">)</span>
                <span class="n">movadded</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="nb">dir</span><span class="o">==</span><span class="n">TURN_THRU</span><span class="p">:</span>
                    <span class="n">thruadded</span><span class="o">=</span><span class="mi">1</span>
            <span class="k">if</span> <span class="nb">dir</span><span class="o">==</span><span class="n">TURN_RIGHT</span> <span class="ow">and</span> <span class="n">thruadded</span><span class="o">==</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">addRightToThru</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">dir</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>

    </div>
<div class="viewcode-block" id="mapMovements"><a class="viewcode-back" href="../script_importExcelSignals.html#importExcelSignals.mapMovements">[docs]</a><span class="k">def</span> <span class="nf">mapMovements</span><span class="p">(</span><span class="n">mec</span><span class="p">,</span> <span class="n">baseNetwork</span><span class="p">):</span>
    
    <span class="c">#dta.DtaLogger.info(&quot;Number of excel cards read %d&quot; % len(excelCards))</span>
    
    <span class="k">def</span> <span class="nf">getStreetName</span><span class="p">(</span><span class="n">gMovName</span><span class="p">,</span> <span class="n">streetNames</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Finds to which street the movement applies to and returns the </span>
<span class="sd">        street&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">streetNames</span><span class="p">)):</span>
            <span class="k">if</span> <span class="s">&quot;3&quot;</span> <span class="ow">in</span> <span class="n">gMovName</span> <span class="ow">and</span> <span class="ow">not</span> <span class="s">&quot;23&quot;</span> <span class="ow">in</span> <span class="n">gMovName</span><span class="p">:</span>
                <span class="k">if</span> <span class="s">&quot;3&quot;</span> <span class="ow">in</span> <span class="n">streetNames</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="s">&quot;23&quot;</span> <span class="ow">in</span> <span class="n">streetNames</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                    <span class="k">return</span> <span class="n">streetNames</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">elif</span> <span class="s">&quot;23&quot;</span> <span class="ow">in</span> <span class="n">gMovName</span><span class="p">:</span>
                <span class="k">if</span> <span class="s">&quot;23&quot;</span> <span class="ow">in</span> <span class="n">streetNames</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                    <span class="k">return</span> <span class="n">streetNames</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">elif</span> <span class="s">&quot;BROADWAY&quot;</span> <span class="ow">in</span> <span class="n">gMovName</span><span class="p">:</span>
                <span class="k">if</span> <span class="s">&quot;TUNNEL&quot;</span> <span class="ow">in</span> <span class="n">gMovName</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s">&quot;BROADWAY&quot;</span> <span class="ow">in</span> <span class="n">streetNames</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">and</span> <span class="s">&quot;TUNNEL&quot;</span> <span class="ow">in</span> <span class="n">streetNames</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                        <span class="k">return</span> <span class="n">streetNames</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">elif</span> <span class="s">&quot;TUNNEL&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">gMovName</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s">&quot;BROADWAY&quot;</span> <span class="ow">in</span> <span class="n">streetNames</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">and</span> <span class="s">&quot;TUNNEL&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">streetNames</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                        <span class="k">return</span> <span class="n">streetNames</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">streetNames</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">in</span> <span class="n">gMovName</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">streetNames</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="n">matches</span> <span class="o">=</span> <span class="n">difflib</span><span class="o">.</span><span class="n">get_close_matches</span><span class="p">(</span><span class="n">gMovName</span><span class="p">,</span> <span class="n">streetNames</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">matches</span><span class="p">:</span>
            <span class="n">bestMatchedStreetName</span> <span class="o">=</span> <span class="n">matches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">bestMatchedStreetName</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">StreetNameMappingError</span><span class="p">(</span><span class="s">&quot;The group movement is not associated with any of the &quot;</span>
                                         <span class="s">&quot;street names that identify the intersection.#</span><span class="si">%s</span><span class="s">#</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> 
                                         <span class="p">(</span><span class="n">gMovName</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">streetNames</span><span class="p">)))</span>
            
    <span class="k">def</span> <span class="nf">getDirections</span><span class="p">(</span><span class="n">gMovName</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Searches the movement name for a known set of strings that indicate the</span>
<span class="sd">        direction of the movment and returns the result(=the direction of the movement)</span>
<span class="sd">        Returns a string representing the direction: WB, EB, NB, SB</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">wbIndicators</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;WB-&quot;</span><span class="p">,</span><span class="s">&quot;WB,&quot;</span><span class="p">,</span> <span class="s">&quot;,WB&quot;</span><span class="p">,</span> <span class="s">&quot;WB/&quot;</span><span class="p">,</span> <span class="s">&quot;/WB&quot;</span><span class="p">,</span> <span class="s">&quot;WB&amp;&quot;</span><span class="p">,</span> <span class="s">&quot;&amp;WB&quot;</span><span class="p">,</span> <span class="s">&quot; WB&quot;</span><span class="p">,</span> <span class="s">&quot;WB &quot;</span><span class="p">,</span> <span class="s">&quot;W/B&quot;</span><span class="p">,</span> <span class="s">&quot;(WB&quot;</span><span class="p">,</span> <span class="s">&quot;WB)&quot;</span><span class="p">,</span> <span class="s">&quot;(WB)&quot;</span><span class="p">,</span> <span class="s">&quot;(WESTBOUND)&quot;</span><span class="p">,</span> <span class="s">&quot;WESTBOUND&quot;</span><span class="p">,</span> <span class="s">&quot;WEST &quot;</span><span class="p">]</span>
        <span class="n">ebIndicators</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;EB-&quot;</span><span class="p">,</span><span class="s">&quot;EB,&quot;</span><span class="p">,</span> <span class="s">&quot;,EB&quot;</span><span class="p">,</span> <span class="s">&quot;EB/&quot;</span><span class="p">,</span> <span class="s">&quot;/EB&quot;</span><span class="p">,</span><span class="s">&quot;EB&amp;&quot;</span><span class="p">,</span> <span class="s">&quot;&amp;EB&quot;</span><span class="p">,</span> <span class="s">&quot; EB&quot;</span><span class="p">,</span> <span class="s">&quot;EB &quot;</span><span class="p">,</span> <span class="s">&quot;E/B&quot;</span><span class="p">,</span> <span class="s">&quot;(EB&quot;</span><span class="p">,</span> <span class="s">&quot;(EB)&quot;</span><span class="p">,</span> <span class="s">&quot;EB)&quot;</span><span class="p">,</span> <span class="s">&quot;(EASTBOUND)&quot;</span><span class="p">,</span> <span class="s">&quot;EASTBOUND&quot;</span><span class="p">,</span> <span class="s">&quot;EAST &quot;</span><span class="p">]</span>        
        <span class="n">nbIndicators</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;NB-&quot;</span><span class="p">,</span><span class="s">&quot;NB,&quot;</span><span class="p">,</span> <span class="s">&quot;,NB&quot;</span><span class="p">,</span> <span class="s">&quot;NB/&quot;</span><span class="p">,</span> <span class="s">&quot;/NB&quot;</span><span class="p">,</span><span class="s">&quot;NB&amp;&quot;</span><span class="p">,</span> <span class="s">&quot;&amp;NB&quot;</span><span class="p">,</span> <span class="s">&quot; NB&quot;</span><span class="p">,</span> <span class="s">&quot;NB &quot;</span><span class="p">,</span> <span class="s">&quot;N/B&quot;</span><span class="p">,</span> <span class="s">&quot;(NB&quot;</span><span class="p">,</span> <span class="s">&quot;NB)&quot;</span><span class="p">,</span> <span class="s">&quot;(NORTHBOUND)&quot;</span><span class="p">,</span> <span class="s">&quot;NORTHBOUND&quot;</span><span class="p">,</span> <span class="s">&quot;NORTH &quot;</span><span class="p">]</span>
        <span class="n">sbIndicators</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;SB-&quot;</span><span class="p">,</span><span class="s">&quot;SB,&quot;</span><span class="p">,</span> <span class="s">&quot;,SB&quot;</span><span class="p">,</span> <span class="s">&quot;SB/&quot;</span><span class="p">,</span> <span class="s">&quot;/SB&quot;</span><span class="p">,</span><span class="s">&quot;SB&amp;&quot;</span><span class="p">,</span> <span class="s">&quot;&amp;SB&quot;</span><span class="p">,</span> <span class="s">&quot; SB&quot;</span><span class="p">,</span> <span class="s">&quot;SB &quot;</span><span class="p">,</span> <span class="s">&quot;S/B&quot;</span><span class="p">,</span> <span class="s">&quot;(SB&quot;</span><span class="p">,</span> <span class="s">&quot;SB)&quot;</span><span class="p">,</span> <span class="s">&quot;(SOUTHBOUND)&quot;</span><span class="p">,</span> <span class="s">&quot;SOUTHBOUND&quot;</span><span class="p">,</span> <span class="s">&quot;SOUTH &quot;</span><span class="p">]</span>
        
        <span class="n">indicators</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;WB&quot;</span><span class="p">:</span><span class="n">wbIndicators</span><span class="p">,</span> <span class="s">&quot;EB&quot;</span><span class="p">:</span><span class="n">ebIndicators</span><span class="p">,</span> <span class="s">&quot;NB&quot;</span><span class="p">:</span><span class="n">nbIndicators</span><span class="p">,</span> <span class="s">&quot;SB&quot;</span><span class="p">:</span><span class="n">sbIndicators</span><span class="p">}</span>
        
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="nb">dir</span><span class="p">,</span> <span class="n">dirIndicators</span> <span class="ow">in</span> <span class="n">indicators</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">indicator</span> <span class="ow">in</span> <span class="n">dirIndicators</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">indicator</span> <span class="ow">in</span> <span class="n">gMovName</span> <span class="ow">and</span> <span class="n">gMovName</span> <span class="o">!=</span> <span class="s">&quot;SOUTH VAN NESS&quot;</span> <span class="ow">and</span> <span class="n">gMovName</span> <span class="o">!=</span> <span class="s">&quot;WEST PORTAL&quot;</span> <span class="ow">and</span> <span class="n">gMovName</span> <span class="o">!=</span> <span class="s">&quot;NORTH POINT&quot;</span> <span class="ow">and</span> <span class="n">gMovName</span> <span class="o">!=</span> <span class="s">&quot;I-80 E OFF-RAMP&quot;</span> <span class="ow">and</span> <span class="n">gMovName</span> <span class="o">!=</span> <span class="s">&quot;HWY 101 SOUTHBOUND RAMP&quot;</span><span class="p">:</span>
                   <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">dir</span><span class="p">)</span>
                   <span class="k">break</span>
       
        <span class="k">return</span> <span class="n">result</span>


    <span class="k">def</span> <span class="nf">mapGroupMovements</span><span class="p">(</span><span class="n">mec</span><span class="p">,</span> <span class="n">groupMovementNames</span><span class="p">,</span> <span class="n">bNode</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Output: populate the mappedMovements dictonary of the excelCard object.</span>
<span class="sd">        The keys of the dictonary are the movement names and its values are</span>
<span class="sd">        all the iids of the corresponding movemens</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">streetNames</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">mec</span><span class="o">.</span><span class="n">streetNames</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">gMovName</span> <span class="ow">in</span> <span class="n">groupMovementNames</span><span class="p">:</span>
            <span class="k">if</span> <span class="s">&quot;DRIVEWAY&quot;</span> <span class="ow">in</span> <span class="n">gMovName</span> <span class="ow">or</span> <span class="s">&quot;FIRE HOUSE&quot;</span> <span class="ow">in</span> <span class="n">gMovName</span> <span class="ow">or</span> <span class="p">(</span><span class="s">&quot;BRIDGE &quot;</span> <span class="ow">in</span> <span class="n">gMovName</span> <span class="ow">and</span> <span class="s">&quot;CAMBRIDGE&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">gMovName</span><span class="p">)</span> <span class="ow">or</span> <span class="s">&quot;RESTRICTION&quot;</span> <span class="ow">in</span> <span class="n">gMovName</span> <span class="ow">or</span> \
               <span class="s">&quot;PIER 39&quot;</span> <span class="ow">in</span> <span class="n">gMovName</span> <span class="ow">or</span> <span class="s">&quot; PEDS&quot;</span> <span class="ow">in</span> <span class="n">gMovName</span> <span class="ow">or</span> <span class="s">&quot;SERVICE ROAD&quot;</span> <span class="ow">in</span> <span class="n">gMovName</span> <span class="ow">or</span> <span class="p">(</span><span class="s">&quot;PARKING&quot;</span> <span class="ow">in</span> <span class="n">gMovName</span> <span class="ow">and</span> <span class="s">&quot;CHURCH&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">gMovName</span><span class="p">)</span> <span class="ow">or</span> \
               <span class="s">&quot;GARAGE&quot;</span> <span class="ow">in</span> <span class="n">gMovName</span> <span class="ow">or</span> <span class="s">&quot;(EMS&quot;</span> <span class="ow">in</span> <span class="n">gMovName</span> <span class="ow">or</span> <span class="s">&quot;LRV PREEMPT&quot;</span> <span class="ow">in</span> <span class="n">gMovName</span> <span class="ow">or</span> <span class="s">&quot;AT BRIDGE&quot;</span> <span class="ow">in</span> <span class="n">gMovName</span> <span class="ow">or</span> <span class="s">&quot;BLIND &quot;</span> <span class="ow">in</span> <span class="n">gMovName</span> <span class="ow">or</span> <span class="s">&quot;STREETCAR&quot;</span> <span class="ow">in</span> <span class="n">gMovName</span> <span class="ow">or</span> \
               <span class="s">&quot;(FAR&quot;</span> <span class="ow">in</span> <span class="n">gMovName</span> <span class="ow">or</span> <span class="s">&quot;SHRADER PATH&quot;</span> <span class="ow">in</span> <span class="n">gMovName</span> <span class="ow">or</span> <span class="s">&quot; WBRT&quot;</span> <span class="ow">in</span> <span class="n">gMovName</span> <span class="ow">or</span> <span class="s">&quot; RT. TURN&quot;</span> <span class="ow">in</span> <span class="n">gMovName</span> <span class="ow">or</span> <span class="s">&quot;XING&quot;</span> <span class="ow">in</span> <span class="n">gMovName</span> <span class="ow">or</span> <span class="s">&quot;PEDS &quot;</span> <span class="ow">in</span> <span class="n">gMovName</span><span class="p">:</span>
                <span class="k">continue</span>


            <span class="c">#for each group movement get the approach&#39;s street name</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">stName</span> <span class="o">=</span> <span class="n">getStreetName</span><span class="p">(</span><span class="n">gMovName</span><span class="p">,</span> <span class="n">streetNames</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">StreetNameMappingError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">StreetNameMappingError</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">#</span><span class="si">%d</span><span class="s">#</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mec</span><span class="o">.</span><span class="n">fileName</span><span class="p">,</span> <span class="n">mec</span><span class="o">.</span><span class="n">mappedNodeId</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
            <span class="n">gTurnTypes</span> <span class="o">=</span> <span class="n">groupMovementToTurnType</span><span class="p">(</span><span class="n">gMovName</span><span class="p">)</span>
            <span class="n">gDirections</span> <span class="o">=</span> <span class="n">getDirections</span><span class="p">(</span><span class="n">gMovName</span><span class="p">)</span>
            <span class="k">if</span> <span class="s">&quot;BUSH&quot;</span> <span class="ow">in</span> <span class="n">gMovName</span> <span class="ow">and</span> <span class="s">&quot;WB&quot;</span> <span class="ow">in</span> <span class="n">gDirections</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="s">&quot;FELL&quot;</span> <span class="ow">in</span> <span class="n">gMovName</span> <span class="ow">and</span> <span class="s">&quot;EB&quot;</span> <span class="ow">in</span> <span class="n">gDirections</span> <span class="ow">and</span> <span class="s">&quot;WB&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">gDirections</span> <span class="ow">and</span> <span class="s">&quot;FRANKLIN&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">streetNames</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="s">&quot;PINE&quot;</span> <span class="ow">in</span> <span class="n">gMovName</span> <span class="ow">and</span> <span class="s">&quot;EB&quot;</span> <span class="ow">in</span> <span class="n">gDirections</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="s">&quot;PIERCE&quot;</span> <span class="ow">in</span> <span class="n">gMovName</span> <span class="ow">and</span> <span class="s">&quot;FELL&quot;</span> <span class="ow">in</span> <span class="n">streetNames</span> <span class="ow">and</span> <span class="s">&quot;NB&quot;</span> <span class="ow">in</span> <span class="n">gDirections</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="s">&quot;LEE&quot;</span> <span class="ow">in</span> <span class="n">gMovName</span> <span class="ow">and</span> <span class="s">&quot;OCEAN&quot;</span> <span class="ow">in</span> <span class="n">streetNames</span> <span class="ow">and</span> <span class="s">&quot;SB&quot;</span> <span class="ow">in</span> <span class="n">gDirections</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&quot;temp_directons.txt&quot;</span><span class="p">,</span> <span class="s">&quot;a&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%25s%20s%20s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">gMovName</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">gTurnTypes</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">gDirections</span><span class="p">)))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">stName</span><span class="p">:</span>
                <span class="n">dta</span><span class="o">.</span><span class="n">DtaLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;I cannot identify the approach of the group &quot;</span>
                                                 <span class="s">&quot;movement </span><span class="si">%s</span><span class="s"> in node </span><span class="si">%s</span><span class="s"> stored as </span><span class="si">%s</span><span class="s">&quot;</span> 
                                                 <span class="o">%</span> <span class="p">(</span><span class="n">gMovName</span><span class="p">,</span> <span class="n">mec</span><span class="o">.</span><span class="n">iName</span><span class="p">,</span> <span class="n">mec</span><span class="o">.</span><span class="n">iiName</span><span class="p">))</span>
                <span class="k">raise</span> <span class="n">MovementMappingError</span><span class="p">(</span><span class="s">&quot;I cannot identify the approach of the group &quot;</span>
                                                 <span class="s">&quot;movement </span><span class="si">%s</span><span class="s"> in node </span><span class="si">%s</span><span class="s"> stored as </span><span class="si">%s</span><span class="s">&quot;</span> 
                                                 <span class="o">%</span> <span class="p">(</span><span class="n">gMovName</span><span class="p">,</span> <span class="n">mec</span><span class="o">.</span><span class="n">iName</span><span class="p">,</span> <span class="n">mec</span><span class="o">.</span><span class="n">iiName</span><span class="p">))</span>
            <span class="n">bStName</span> <span class="o">=</span> <span class="n">mec</span><span class="o">.</span><span class="n">mappedStreet</span><span class="p">[</span><span class="n">stName</span><span class="p">]</span>
            <span class="c">#collect all the links of the approach that have the same direction</span>
            <span class="n">gLinks</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="s">&quot;3&quot;</span> <span class="ow">in</span> <span class="n">bStName</span> <span class="ow">and</span> <span class="s">&quot;23&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">bStName</span><span class="p">:</span>
                <span class="n">candLinks</span> <span class="o">=</span> <span class="p">[</span><span class="n">link</span> <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">bNode</span><span class="o">.</span><span class="n">iterIncomingLinks</span><span class="p">()</span> <span class="k">if</span> <span class="s">&quot;3&quot;</span> <span class="ow">in</span> <span class="n">link</span><span class="o">.</span><span class="n">getLabel</span><span class="p">()</span> <span class="ow">and</span> <span class="s">&quot;23&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">link</span><span class="o">.</span><span class="n">getLabel</span><span class="p">()]</span>
            <span class="k">elif</span> <span class="s">&quot;3&quot;</span> <span class="ow">in</span> <span class="n">bStName</span> <span class="ow">and</span> <span class="s">&quot;23&quot;</span> <span class="ow">in</span> <span class="n">bStName</span><span class="p">:</span>
                <span class="n">candLinks</span> <span class="o">=</span> <span class="p">[</span><span class="n">link</span> <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">bNode</span><span class="o">.</span><span class="n">iterIncomingLinks</span><span class="p">()</span> <span class="k">if</span> <span class="s">&quot;3&quot;</span> <span class="ow">in</span> <span class="n">link</span><span class="o">.</span><span class="n">getLabel</span><span class="p">()</span> <span class="ow">and</span> <span class="s">&quot;23&quot;</span> <span class="ow">in</span> <span class="n">link</span><span class="o">.</span><span class="n">getLabel</span><span class="p">()]</span>
            <span class="k">elif</span> <span class="s">&quot;BROADWAY&quot;</span> <span class="ow">in</span> <span class="n">bStName</span> <span class="ow">and</span> <span class="s">&quot;TUNNEL&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">bStName</span><span class="p">:</span>
                <span class="n">candLinks</span> <span class="o">=</span> <span class="p">[</span><span class="n">link</span> <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">bNode</span><span class="o">.</span><span class="n">iterIncomingLinks</span><span class="p">()</span> <span class="k">if</span> <span class="s">&quot;BROADWAY&quot;</span> <span class="ow">in</span> <span class="n">link</span><span class="o">.</span><span class="n">getLabel</span><span class="p">()</span> <span class="ow">and</span> <span class="s">&quot;TUNNEL&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">link</span><span class="o">.</span><span class="n">getLabel</span><span class="p">()]</span>
            <span class="k">elif</span> <span class="s">&quot;BROADWAY&quot;</span> <span class="ow">in</span> <span class="n">bStName</span> <span class="ow">and</span> <span class="s">&quot;TUNNEL&quot;</span> <span class="ow">in</span> <span class="n">bStName</span><span class="p">:</span>
                <span class="n">candLinks</span> <span class="o">=</span> <span class="p">[</span><span class="n">link</span> <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">bNode</span><span class="o">.</span><span class="n">iterIncomingLinks</span><span class="p">()</span> <span class="k">if</span> <span class="s">&quot;BROADWAY&quot;</span> <span class="ow">in</span> <span class="n">link</span><span class="o">.</span><span class="n">getLabel</span><span class="p">()</span> <span class="ow">and</span> <span class="s">&quot;TUNNEL&quot;</span> <span class="ow">in</span> <span class="n">link</span><span class="o">.</span><span class="n">getLabel</span><span class="p">()]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">candLinks</span> <span class="o">=</span> <span class="p">[</span><span class="n">link</span> <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">bNode</span><span class="o">.</span><span class="n">iterIncomingLinks</span><span class="p">()</span> <span class="k">if</span> <span class="n">bStName</span> <span class="ow">in</span> <span class="n">link</span><span class="o">.</span><span class="n">getLabel</span><span class="p">()]</span>
            <span class="k">for</span> <span class="n">candLink</span> <span class="ow">in</span> <span class="n">candLinks</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">gDirections</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">getPossibleLinkDirections</span><span class="p">(</span><span class="n">candLink</span><span class="p">))</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">gDirections</span><span class="p">):</span>
                        <span class="n">gLinks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">candLink</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">gLinks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">candLink</span><span class="p">)</span>

            <span class="c">#dta.DtaLogger.info(&quot;Movement %s for street %s has links %s&quot; % (gMovName,bStName,str([links.getLabel() for links in gLinks])))</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gLinks</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">dta</span><span class="o">.</span><span class="n">DtaLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">#</span><span class="si">%d</span><span class="s">#I cannot identify the links for the group &quot;</span>
                               <span class="s">&quot;movement #</span><span class="si">%s</span><span class="s"># in node #</span><span class="si">%s</span><span class="s"># stored as #</span><span class="si">%s</span><span class="s"># candidate links are # </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span>
                                                 <span class="p">(</span><span class="n">mec</span><span class="o">.</span><span class="n">fileName</span><span class="p">,</span> <span class="n">mec</span><span class="o">.</span><span class="n">mappedNodeId</span><span class="p">,</span> <span class="n">gMovName</span><span class="p">,</span> <span class="n">mec</span><span class="o">.</span><span class="n">iName</span><span class="p">,</span> <span class="n">mec</span><span class="o">.</span><span class="n">iiName</span><span class="p">,</span> <span class="nb">str</span><span class="p">([</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">,</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">candLink</span><span class="o">.</span><span class="n">getLabel</span><span class="p">(),</span> <span class="n">candLink</span><span class="o">.</span><span class="n">getDirection</span><span class="p">())</span> <span class="k">for</span> <span class="n">candLink</span> <span class="ow">in</span> <span class="n">candLinks</span><span class="p">])))</span>

                <span class="k">raise</span> <span class="n">MovementMappingError</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">#</span><span class="si">%d</span><span class="s">#I cannot identify the links for the group &quot;</span>
                               <span class="s">&quot;movement #</span><span class="si">%s</span><span class="s"># in node #</span><span class="si">%s</span><span class="s"># stored as #</span><span class="si">%s</span><span class="s"># candidate links are # </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span>
                                                 <span class="p">(</span><span class="n">mec</span><span class="o">.</span><span class="n">fileName</span><span class="p">,</span> <span class="n">mec</span><span class="o">.</span><span class="n">mappedNodeId</span><span class="p">,</span> <span class="n">gMovName</span><span class="p">,</span> <span class="n">mec</span><span class="o">.</span><span class="n">iName</span><span class="p">,</span> <span class="n">mec</span><span class="o">.</span><span class="n">iiName</span><span class="p">,</span> <span class="nb">str</span><span class="p">([</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">,</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">candLink</span><span class="o">.</span><span class="n">getLabel</span><span class="p">(),</span> <span class="n">candLink</span><span class="o">.</span><span class="n">getDirection</span><span class="p">())</span> <span class="k">for</span> <span class="n">candLink</span> <span class="ow">in</span> <span class="n">candLinks</span><span class="p">])))</span>

            <span class="n">gMovements</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">gTurnTypes</span><span class="p">:</span>
                <span class="n">availableMovs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">chain</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">link</span><span class="o">.</span><span class="n">iterOutgoingMovements</span><span class="p">()</span> <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">gLinks</span><span class="p">]))</span>
                <span class="k">for</span> <span class="n">mov</span> <span class="ow">in</span> <span class="n">availableMovs</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">mov</span><span class="o">.</span><span class="n">getTurnType</span><span class="p">()</span> <span class="ow">in</span> <span class="n">gTurnTypes</span><span class="p">:</span>
                        <span class="n">gMovements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mov</span><span class="p">)</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gMovements</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">dta</span><span class="o">.</span><span class="n">DtaLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> # </span><span class="si">%d</span><span class="s"> # cannot identify the movements for the group &quot;</span>
                  <span class="s">&quot;movement </span><span class="si">%s</span><span class="s"> in node </span><span class="si">%s</span><span class="s"> stored as </span><span class="si">%s</span><span class="s">. The streetNames are: </span><span class="si">%s</span><span class="s"> , the directions of the group are </span><span class="si">%s</span><span class="s">. The available movemements are </span><span class="si">%s</span><span class="s">&quot;</span> 
                                           <span class="o">%</span> <span class="p">(</span><span class="n">mec</span><span class="o">.</span><span class="n">fileName</span><span class="p">,</span> <span class="n">mec</span><span class="o">.</span><span class="n">mappedNodeId</span><span class="p">,</span> <span class="n">gMovName</span><span class="p">,</span> <span class="n">mec</span><span class="o">.</span><span class="n">iName</span><span class="p">,</span> <span class="n">mec</span><span class="o">.</span><span class="n">iiName</span><span class="p">,</span>
                                              <span class="nb">str</span><span class="p">(</span><span class="n">mec</span><span class="o">.</span><span class="n">streetNames</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">gDirections</span><span class="p">),</span> <span class="nb">str</span><span class="p">([</span><span class="n">mov</span><span class="o">.</span><span class="n">getDirection</span><span class="p">()</span> <span class="k">for</span> <span class="n">mov</span> <span class="ow">in</span> <span class="n">availableMovs</span><span class="p">])))</span>
                    <span class="k">raise</span> <span class="n">MovementMappingError</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> # </span><span class="si">%d</span><span class="s"> # cannot identify the movements for the group &quot;</span>
                  <span class="s">&quot;movement </span><span class="si">%s</span><span class="s"> in node </span><span class="si">%s</span><span class="s"> stored as </span><span class="si">%s</span><span class="s">. The streetNames are: </span><span class="si">%s</span><span class="s"> , the directions of the group are </span><span class="si">%s</span><span class="s">. The available movemements are </span><span class="si">%s</span><span class="s">&quot;</span> 
                                           <span class="o">%</span> <span class="p">(</span><span class="n">mec</span><span class="o">.</span><span class="n">fileName</span><span class="p">,</span> <span class="n">mec</span><span class="o">.</span><span class="n">mappedNodeId</span><span class="p">,</span> <span class="n">gMovName</span><span class="p">,</span> <span class="n">mec</span><span class="o">.</span><span class="n">iName</span><span class="p">,</span> <span class="n">mec</span><span class="o">.</span><span class="n">iiName</span><span class="p">,</span>
                                              <span class="nb">str</span><span class="p">(</span><span class="n">mec</span><span class="o">.</span><span class="n">streetNames</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">gDirections</span><span class="p">),</span> <span class="nb">str</span><span class="p">([</span><span class="n">mov</span><span class="o">.</span><span class="n">getDirection</span><span class="p">()</span> <span class="k">for</span> <span class="n">mov</span> <span class="ow">in</span> <span class="n">availableMovs</span><span class="p">])))</span>
                       
            <span class="k">else</span><span class="p">:</span>    
                <span class="n">gMovements</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">chain</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">link</span><span class="o">.</span><span class="n">iterOutgoingMovements</span><span class="p">()</span> <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">gLinks</span><span class="p">]))</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gMovements</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">dta</span><span class="o">.</span><span class="n">DtaLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">#</span><span class="si">%d</span><span class="s">#I cannot identify the movements for the group &quot;</span>
                  <span class="s">&quot;movement </span><span class="si">%s</span><span class="s"> in node </span><span class="si">%s</span><span class="s"> stored as </span><span class="si">%s</span><span class="s">. The streetNames are: </span><span class="si">%s</span><span class="s"> , the directions of the group are </span><span class="si">%s</span><span class="s"> &quot;</span> 
                                           <span class="o">%</span> <span class="p">(</span><span class="n">mec</span><span class="o">.</span><span class="n">fileName</span><span class="p">,</span> <span class="n">mec</span><span class="o">.</span><span class="n">mappedNodeId</span><span class="p">,</span> <span class="n">gMovName</span><span class="p">,</span> <span class="n">mec</span><span class="o">.</span><span class="n">iName</span><span class="p">,</span> <span class="n">mec</span><span class="o">.</span><span class="n">iiName</span><span class="p">,</span> 
                                              <span class="nb">str</span><span class="p">(</span><span class="n">mec</span><span class="o">.</span><span class="n">streetNames</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">gDirections</span><span class="p">)))</span>
                <span class="k">raise</span> <span class="n">MovementMappingError</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">#</span><span class="si">%d</span><span class="s">#I cannot identify the movements for the group &quot;</span>
                  <span class="s">&quot;movement </span><span class="si">%s</span><span class="s"> in node </span><span class="si">%s</span><span class="s"> stored as </span><span class="si">%s</span><span class="s">. The streetNames are: </span><span class="si">%s</span><span class="s"> , the directions of the group are </span><span class="si">%s</span><span class="s"> &quot;</span> 
                                           <span class="o">%</span> <span class="p">(</span><span class="n">mec</span><span class="o">.</span><span class="n">fileName</span><span class="p">,</span> <span class="n">mec</span><span class="o">.</span><span class="n">mappedNodeId</span><span class="p">,</span> <span class="n">gMovName</span><span class="p">,</span> <span class="n">mec</span><span class="o">.</span><span class="n">iName</span><span class="p">,</span> <span class="n">mec</span><span class="o">.</span><span class="n">iiName</span><span class="p">,</span> 
                                              <span class="nb">str</span><span class="p">(</span><span class="n">mec</span><span class="o">.</span><span class="n">streetNames</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">gDirections</span><span class="p">)))</span>
<span class="c">##                raise MovementMappingError(&quot;%s#%d#I cannot identify the movements for the group &quot;</span>
<span class="c">##                  &quot;movement %s in node %s stored as %s. The streetNames are: %s , the directions of the group are %s &quot; </span>
<span class="c">##                                           % (mec.fileName, mec.mappedNodeId, gMovName, mec.iName, mec.iiName, </span>
<span class="c">##                                              str(mec.streetNames), str(gDirections)))</span>
<span class="c">#                    `                       &quot;group are: %s and the turn types: %s&quot; %     </span>
<span class="c">#                                                 (gMovName, mec.iName, mec.iiName, gDirections, gTurnTypes))</span>
                

            <span class="n">gMovements</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">gMovements</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">elem</span><span class="p">:</span> <span class="n">elem</span><span class="o">.</span><span class="n">getId</span><span class="p">())</span>

            <span class="k">for</span> <span class="n">mov</span> <span class="ow">in</span> <span class="n">gMovements</span><span class="p">:</span>
                <span class="n">mec</span><span class="o">.</span><span class="n">mappedMovements</span><span class="p">[</span><span class="n">gMovName</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mov</span><span class="o">.</span><span class="n">getId</span><span class="p">())</span>

    <span class="n">index</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="c">## Commented lines are from format change.  Original code parsed all of the signal cards, then mapped them, then created time phases.</span>
    <span class="c">## New code performs all processes on one excel card before moving to the next card.</span>
    
    <span class="c">#excelCardsWithMovements = []    </span>
    <span class="c">#for mec in excelCards:</span>

    <span class="k">if</span> <span class="n">mec</span><span class="o">.</span><span class="n">mappedNodeId</span> <span class="o">==</span> <span class="o">-</span><span class="mi">9999</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="c">#if there is a match</span>
    <span class="k">if</span> <span class="n">mec</span><span class="o">.</span><span class="n">mappedNodeId</span> <span class="ow">and</span> <span class="n">mec</span><span class="o">.</span><span class="n">phasingData</span><span class="p">:</span> 
        <span class="c">#get the mapped node</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">baseNetwork</span><span class="o">.</span><span class="n">hasNodeForId</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">mec</span><span class="o">.</span><span class="n">mappedNodeId</span><span class="p">)):</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="n">bNode</span> <span class="o">=</span> <span class="n">baseNetwork</span><span class="o">.</span><span class="n">getNodeForId</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">mec</span><span class="o">.</span><span class="n">mappedNodeId</span><span class="p">))</span>
        <span class="c">#get the groupMovementNames</span>
        <span class="n">groupMovementNames</span> <span class="o">=</span> <span class="n">mec</span><span class="o">.</span><span class="n">phasingData</span><span class="o">.</span><span class="n">getElementsOfDimention</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">numGroupMovements</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">groupMovementNames</span><span class="p">)</span>
        <span class="n">numSteps</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mec</span><span class="o">.</span><span class="n">phasingData</span><span class="o">.</span><span class="n">getElementsOfDimention</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">index</span><span class="p">[</span><span class="n">numGroupMovements</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c">#for each group movement get the approach&#39;s street name</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">mapGroupMovements</span><span class="p">(</span><span class="n">mec</span><span class="p">,</span> <span class="n">groupMovementNames</span><span class="p">,</span> <span class="n">bNode</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">MovementMappingError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">dta</span><span class="o">.</span><span class="n">DtaLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;MovementMappingError:   </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">except</span> <span class="n">StreetNameMappingError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">dta</span><span class="o">.</span><span class="n">DtaLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;StreetNameMappingError: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="k">return</span> <span class="bp">False</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mec</span><span class="o">.</span><span class="n">mappedMovements</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">dta</span><span class="o">.</span><span class="n">DtaLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Signal </span><span class="si">%s</span><span class="s">. No mapped movements&quot;</span> <span class="o">%</span> <span class="n">mec</span><span class="o">.</span><span class="n">fileName</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">False</span>
        <span class="c">#raise MovementMappingError(&quot;Signal %s. No mapped movements&quot; % mec.fileName)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mec</span><span class="o">.</span><span class="n">mappedMovements</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">dta</span><span class="o">.</span><span class="n">DtaLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Signal </span><span class="si">%s</span><span class="s">. Only one of the group movements has been mapped&quot;</span> <span class="o">%</span>
                        <span class="n">mec</span><span class="o">.</span><span class="n">fileName</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">False</span>
<span class="c">#       raise MovementMappingError(&quot;Signal %s. Cannot generate a signal with &quot;</span>
<span class="c">#                               &quot;only one movement&quot; % mec.fileName)</span>

    <span class="n">groupMovements</span> <span class="o">=</span> <span class="n">mec</span><span class="o">.</span><span class="n">phasingData</span><span class="o">.</span><span class="n">getElementsOfDimention</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">streetNames</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">mec</span><span class="o">.</span><span class="n">streetNames</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">gMovName</span> <span class="ow">in</span> <span class="n">groupMovements</span><span class="p">:</span>
        <span class="k">if</span> <span class="s">&quot;DRIVEWAY&quot;</span> <span class="ow">in</span> <span class="n">gMovName</span> <span class="ow">or</span> <span class="s">&quot;FIRE HOUSE&quot;</span> <span class="ow">in</span> <span class="n">gMovName</span> <span class="ow">or</span> <span class="p">(</span><span class="s">&quot;BRIDGE &quot;</span> <span class="ow">in</span> <span class="n">gMovName</span> <span class="ow">and</span> <span class="s">&quot;CAMBRIDGE&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">gMovName</span><span class="p">)</span> <span class="ow">or</span> <span class="s">&quot;RESTRICTION&quot;</span> <span class="ow">in</span> <span class="n">gMovName</span> <span class="ow">or</span> \
           <span class="s">&quot;PIER 39&quot;</span> <span class="ow">in</span> <span class="n">gMovName</span> <span class="ow">or</span> <span class="s">&quot; PEDS&quot;</span> <span class="ow">in</span> <span class="n">gMovName</span> <span class="ow">or</span> <span class="s">&quot;SERVICE ROAD&quot;</span> <span class="ow">in</span> <span class="n">gMovName</span> <span class="ow">or</span> <span class="p">(</span><span class="s">&quot;PARKING&quot;</span> <span class="ow">in</span> <span class="n">gMovName</span> <span class="ow">and</span> <span class="s">&quot;CHURCH&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">gMovName</span><span class="p">)</span> <span class="ow">or</span> \
           <span class="s">&quot;GARAGE&quot;</span> <span class="ow">in</span> <span class="n">gMovName</span> <span class="ow">or</span> <span class="s">&quot;(EMS&quot;</span> <span class="ow">in</span> <span class="n">gMovName</span> <span class="ow">or</span> <span class="s">&quot;LRV PREEMPT&quot;</span> <span class="ow">in</span> <span class="n">gMovName</span> <span class="ow">or</span> <span class="s">&quot;AT BRIDGE&quot;</span> <span class="ow">in</span> <span class="n">gMovName</span> <span class="ow">or</span> <span class="s">&quot;BLIND &quot;</span> <span class="ow">in</span> <span class="n">gMovName</span> <span class="ow">or</span> <span class="s">&quot;STREETCAR&quot;</span> <span class="ow">in</span> <span class="n">gMovName</span> <span class="ow">or</span> \
           <span class="s">&quot;(FAR&quot;</span> <span class="ow">in</span> <span class="n">gMovName</span> <span class="ow">or</span> <span class="s">&quot;SHRADER PATH&quot;</span> <span class="ow">in</span> <span class="n">gMovName</span> <span class="ow">or</span> <span class="s">&quot; WBRT&quot;</span> <span class="ow">in</span> <span class="n">gMovName</span> <span class="ow">or</span> <span class="s">&quot; RT. TURN&quot;</span> <span class="ow">in</span> <span class="n">gMovName</span> <span class="ow">or</span> <span class="s">&quot;XING&quot;</span> <span class="ow">in</span> <span class="n">gMovName</span> <span class="ow">or</span> <span class="s">&quot;PEDS &quot;</span> <span class="ow">in</span> <span class="n">gMovName</span><span class="p">:</span>
            <span class="n">MovementNames</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">groupMovements</span><span class="p">)</span>
            <span class="n">MovementNames</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">gMovName</span><span class="p">)</span>
            <span class="n">groupMovements</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">MovementNames</span><span class="p">)</span>

        <span class="n">gTurnTypes</span> <span class="o">=</span> <span class="n">groupMovementToTurnType</span><span class="p">(</span><span class="n">gMovName</span><span class="p">)</span>
        <span class="n">gDirections</span> <span class="o">=</span> <span class="n">getDirections</span><span class="p">(</span><span class="n">gMovName</span><span class="p">)</span>
        <span class="k">if</span> <span class="s">&quot;BUSH&quot;</span> <span class="ow">in</span> <span class="n">gMovName</span> <span class="ow">and</span> <span class="s">&quot;WB&quot;</span> <span class="ow">in</span> <span class="n">gDirections</span><span class="p">:</span>
            <span class="n">MovementNames</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">groupMovements</span><span class="p">)</span>
            <span class="n">MovementNames</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">gMovName</span><span class="p">)</span>
            <span class="n">groupMovements</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">MovementNames</span><span class="p">)</span>
        <span class="k">if</span> <span class="s">&quot;FELL&quot;</span> <span class="ow">in</span> <span class="n">gMovName</span> <span class="ow">and</span> <span class="s">&quot;EB&quot;</span> <span class="ow">in</span> <span class="n">gDirections</span> <span class="ow">and</span> <span class="s">&quot;WB&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">gDirections</span> <span class="ow">and</span> <span class="s">&quot;FRANKLIN&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">streetNames</span><span class="p">:</span>
            <span class="n">MovementNames</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">groupMovements</span><span class="p">)</span>
            <span class="n">MovementNames</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">gMovName</span><span class="p">)</span>
            <span class="n">groupMovements</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">MovementNames</span><span class="p">)</span>
        <span class="k">if</span> <span class="s">&quot;PINE&quot;</span> <span class="ow">in</span> <span class="n">gMovName</span> <span class="ow">and</span> <span class="s">&quot;EB&quot;</span> <span class="ow">in</span> <span class="n">gDirections</span><span class="p">:</span>
            <span class="n">MovementNames</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">groupMovements</span><span class="p">)</span>
            <span class="n">MovementNames</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">gMovName</span><span class="p">)</span>
            <span class="n">groupMovements</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">MovementNames</span><span class="p">)</span>
        <span class="k">if</span> <span class="s">&quot;PIERCE&quot;</span> <span class="ow">in</span> <span class="n">gMovName</span> <span class="ow">and</span> <span class="s">&quot;FELL&quot;</span> <span class="ow">in</span> <span class="n">streetNames</span> <span class="ow">and</span> <span class="s">&quot;NB&quot;</span> <span class="ow">in</span> <span class="n">gDirections</span><span class="p">:</span>
            <span class="n">MovementNames</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">groupMovements</span><span class="p">)</span>
            <span class="n">MovementNames</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">gMovName</span><span class="p">)</span>
            <span class="n">groupMovements</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">MovementNames</span><span class="p">)</span>
        <span class="k">if</span> <span class="s">&quot;LEE&quot;</span> <span class="ow">in</span> <span class="n">gMovName</span> <span class="ow">and</span> <span class="s">&quot;OCEAN&quot;</span> <span class="ow">in</span> <span class="n">streetNames</span> <span class="ow">and</span> <span class="s">&quot;SB&quot;</span> <span class="ow">in</span> <span class="n">gDirections</span><span class="p">:</span>
            <span class="n">MovementNames</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">groupMovements</span><span class="p">)</span>
            <span class="n">MovementNames</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">gMovName</span><span class="p">)</span>
            <span class="n">groupMovements</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">MovementNames</span><span class="p">)</span>  
        
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mec</span><span class="o">.</span><span class="n">mappedMovements</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">groupMovements</span><span class="p">):</span>
        <span class="n">dta</span><span class="o">.</span><span class="n">DtaLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Signal </span><span class="si">%s</span><span class="s">. Not all movements have been mapped&quot;</span> <span class="o">%</span> <span class="n">mec</span><span class="o">.</span><span class="n">fileName</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">False</span>

<span class="c">#       raise MovementMappingError(&quot;Signal %s. Not all movements have been mapped&quot; %</span>
<span class="c">#                               mec.fileName)</span>
    <span class="k">for</span> <span class="n">gMov</span> <span class="ow">in</span> <span class="n">groupMovements</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mec</span><span class="o">.</span><span class="n">mappedMovements</span><span class="p">[</span><span class="n">gMov</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">dta</span><span class="o">.</span><span class="n">DtaLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Signal </span><span class="si">%s</span><span class="s">. The group movement </span><span class="si">%s</span><span class="s"> is not mapped to &quot;</span>
                            <span class="s">&quot;any link movements&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mec</span><span class="o">.</span><span class="n">fileName</span><span class="p">,</span> <span class="n">gMov</span><span class="p">))</span>
            <span class="k">return</span> <span class="bp">False</span>
<span class="c">#           raise MovementMappingError(&quot;Signal %s. The group movmement %s is not mapped&quot;</span>
<span class="c">#                                   &quot;to any link movemenets&quot; % (mec.iName, gMov))</span>
    <span class="n">excelCardsWithMovements</span> <span class="o">=</span> <span class="p">(</span><span class="n">mec</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">excelCardsWithMovements</span>
</div>
<div class="viewcode-block" id="checkNumberofTimes"><a class="viewcode-back" href="../script_importExcelSignals.html#importExcelSignals.checkNumberofTimes">[docs]</a><span class="k">def</span> <span class="nf">checkNumberofTimes</span><span class="p">(</span><span class="n">excelCard</span><span class="p">,</span> <span class="n">startTime</span><span class="p">,</span> <span class="n">endTime</span><span class="p">):</span>
<span class="c">#   checks to see if a card has more than one CSO that matches the start and end time </span>
    <span class="n">nummatches</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">signalTiming</span> <span class="ow">in</span> <span class="n">excelCard</span><span class="o">.</span><span class="n">iterSignalTiming</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">startTime</span> <span class="o">&gt;=</span> <span class="n">signalTiming</span><span class="o">.</span><span class="n">startTime</span> <span class="ow">and</span> <span class="n">endTime</span> <span class="o">&lt;=</span> <span class="n">signalTiming</span><span class="o">.</span><span class="n">endTime</span> <span class="ow">and</span> <span class="n">signalTiming</span><span class="o">.</span><span class="n">endTime</span><span class="o">&gt;</span><span class="n">signalTiming</span><span class="o">.</span><span class="n">startTime</span><span class="p">:</span>
                <span class="n">nummatches</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">nummatches</span> <span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">signalTiming</span> <span class="ow">in</span> <span class="n">excelCard</span><span class="o">.</span><span class="n">iterSignalTiming</span><span class="p">():</span>
            <span class="n">dta</span><span class="o">.</span><span class="n">DtaLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Timing is start time </span><span class="si">%s</span><span class="s">, end time </span><span class="si">%s</span><span class="s"> for CSO </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">signalTiming</span><span class="o">.</span><span class="n">startTime</span><span class="p">,</span> <span class="n">signalTiming</span><span class="o">.</span><span class="n">endTime</span><span class="p">,</span> <span class="n">signalTiming</span><span class="o">.</span><span class="n">cso</span><span class="p">))</span> 
    <span class="k">return</span> <span class="n">nummatches</span>
  </div>
<div class="viewcode-block" id="selectCSO"><a class="viewcode-back" href="../script_importExcelSignals.html#importExcelSignals.selectCSO">[docs]</a><span class="k">def</span> <span class="nf">selectCSO</span><span class="p">(</span><span class="n">excelCard</span><span class="p">,</span> <span class="n">startTime</span><span class="p">,</span> <span class="n">endTime</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    returns the ExcelSignalTiming if there is one that is in operation during the </span>
<span class="sd">    input hours. Otherwise it returns none</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">## Changed from looping through all cards here to looping through the cards in the main program section</span>
<span class="c">##    for signalTiming in excelCard.iterSignalTiming():</span>
<span class="c">##        dta.DtaLogger.error(&quot;start time is %s, end time is %s&quot; % (signalTiming.startTime,signalTiming.endTime))</span>
    
    <span class="k">for</span> <span class="n">signalTiming</span> <span class="ow">in</span> <span class="n">excelCard</span><span class="o">.</span><span class="n">iterSignalTiming</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">startTime</span> <span class="o">&gt;=</span> <span class="n">signalTiming</span><span class="o">.</span><span class="n">startTime</span> <span class="ow">and</span> <span class="n">startTime</span> <span class="o">&lt;=</span> <span class="n">signalTiming</span><span class="o">.</span><span class="n">endTime</span> <span class="ow">and</span> <span class="n">signalTiming</span><span class="o">.</span><span class="n">endTime</span><span class="o">&gt;</span><span class="n">signalTiming</span><span class="o">.</span><span class="n">startTime</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">signalTiming</span>
    <span class="k">for</span> <span class="n">signalTiming</span> <span class="ow">in</span> <span class="n">excelCard</span><span class="o">.</span><span class="n">iterSignalTiming</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">signalTiming</span><span class="o">.</span><span class="n">startTime</span> <span class="o">==</span> <span class="n">dta</span><span class="o">.</span><span class="n">Time</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="n">signalTiming</span><span class="o">.</span><span class="n">endTime</span> <span class="o">==</span> <span class="n">dta</span><span class="o">.</span><span class="n">Time</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">signalTiming</span>
    <span class="k">for</span> <span class="n">signalTiming</span> <span class="ow">in</span> <span class="n">excelCard</span><span class="o">.</span><span class="n">iterSignalTiming</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">signalTiming</span><span class="o">.</span><span class="n">startTime</span> <span class="o">==</span> <span class="n">dta</span><span class="o">.</span><span class="n">Time</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="n">signalTiming</span><span class="o">.</span><span class="n">endTime</span> <span class="o">==</span> <span class="n">dta</span><span class="o">.</span><span class="n">Time</span><span class="p">(</span><span class="mi">23</span><span class="p">,</span><span class="mi">59</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">signalTiming</span>
    <span class="k">return</span> <span class="bp">None</span>

    <span class="c">## Assocated with pickle testing not used   </span>
<span class="c">##def readNetIndex():</span>
<span class="c">##</span>
<span class="c">##    index = {}</span>
<span class="c">##    for line in open(&#39;/Users/michalis/Documents/myPythonPrograms/pbTools/pbProjects/doyleDTA/indexSep1v2.txt&#39;):</span>
<span class="c">##        links = line.strip().split(&#39;,&#39;)</span>
<span class="c">##        index[tuple(links[0].split())] = [tuple(link.split()) for link in links[1:]]</span>
<span class="c">##    </span>
<span class="c">##    return index</span>

<span class="c">##def pickleCards(outfileName, cards):</span>
<span class="c">##    &quot;&quot;&quot;</span>
<span class="c">##    Pickle the cards into the outfileName</span>
<span class="c">##    &quot;&quot;&quot;</span>
<span class="c">##    outputStream = open(outfileName, &quot;wb&quot;)</span>
<span class="c">##    pickle.dump(cards, outputStream)</span>
<span class="c">##    outputStream.close()    </span>
<span class="c">##</span>
<span class="c">##def unPickleCards(fileName):</span>
<span class="c">##    &quot;&quot;&quot;</span>
<span class="c">##    Unpickle the cards stored in the file and return them</span>
<span class="c">##    &quot;&quot;&quot;</span>
<span class="c">##    pkl_file = open(fileName, &quot;rb&quot;)</span>
<span class="c">##    excelCards = pickle.load(pkl_file)</span>
<span class="c">##    pkl_file.close()</span>
<span class="c">##    return excelCards</span>
</div>
<div class="viewcode-block" id="getExcelFileNames"><a class="viewcode-back" href="../script_importExcelSignals.html#importExcelSignals.getExcelFileNames">[docs]</a><span class="k">def</span> <span class="nf">getExcelFileNames</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>

    <span class="n">fileNames</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">fileName</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">fileName</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&quot;xls&quot;</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">fileName</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;System&quot;</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="n">fileNames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">fileNames</span>

<span class="c">##def mapIntersections(excelCards, mappedingFile):</span>
<span class="c">##    &quot;&quot;&quot;for each excel card in the find the node in the base network </span>
<span class="c">##    it corresponds&quot;&quot;&quot;</span>
<span class="c">##</span>
<span class="c">##    mapping = {}</span>
<span class="c">##    cardsByName = {}</span>
<span class="c">##    for card in excelCards:</span>
<span class="c">##        cardsByName[card.fileName] = card</span>
<span class="c">##        </span>
<span class="c">##    iStream = open(mappingFile, &quot;r&quot;)</span>
<span class="c">##    for rec in csv.DictReader(iStream):</span>
<span class="c">##        if float(rec[&quot;Distance&quot;]) &gt; 90:</span>
<span class="c">##            continue</span>
<span class="c">##        mapping[rec[&quot;FNAME&quot;]] = rec[&quot;ID_1&quot;]</span>
<span class="c">##        if rec[&quot;FNAME&quot;] in cardsByName:</span>
<span class="c">##            cardsByName[rec[&quot;FNAME&quot;]].mappedNodeId = int(float(rec[&quot;ID_1&quot;]))</span>
<span class="c">##        else:</span>
<span class="c">##            pass</span>
<span class="c">##            #print rec[&quot;FNAME&quot;]</span>
<span class="c">##        </span>
<span class="c">##    #excelCard.mappedNodeName = node.streetNames</span>
<span class="c">##    #excelCard.mappedNodeId = node.iid</span>
<span class="c">##</span>
<span class="c">##    output = open(&quot;/Users/michalis/Dropbox/tmp/mappedCards.txt&quot;, &quot;w&quot;)</span>
<span class="c">##    #output = open(&quot;mappedCards.txt&quot;, &quot;w&quot;) </span>
<span class="c">##    for card in excelCards:</span>
<span class="c">##        if card.mappedNodeId:</span>
<span class="c">##            output.write(&quot;%s\t%s\n&quot; % (card.fileName, card.mappedNodeId))</span>
<span class="c">##        else:</span>
<span class="c">##            card.mappedNodeId = &quot;-9999&quot;</span>
<span class="c">##            output.write(&quot;%s\t%s\n&quot; % (card.fileName, card.mappedNodeId))            </span>
<span class="c">##            </span>
<span class="c">##    output.close()</span>
<span class="c">##    return excelCards</span>

<span class="c">##def getTestScenario(): </span>
<span class="c">##    &quot;&quot;&quot;</span>
<span class="c">##    return a test scenario</span>
<span class="c">##    &quot;&quot;&quot;</span>
<span class="c">##    projectFolder = &quot;/Users/michalis/Documents/workspace/dta/dev/testdata/dynameqNetwork_gearySubset&quot;</span>
<span class="c">##    prefix = &#39;smallTestNet&#39; </span>
<span class="c">##</span>
<span class="c">##    scenario = DynameqScenario(datetime.datetime(2010,1,1,0,0,0), </span>
<span class="c">##                               datetime.datetime(2010,1,1,4,0,0))</span>
<span class="c">##    scenario.read(projectFolder, prefix) </span>
<span class="c">##</span>
<span class="c">##    return scenario </span>
</div>
<div class="viewcode-block" id="assignCardNames"><a class="viewcode-back" href="../script_importExcelSignals.html#importExcelSignals.assignCardNames">[docs]</a><span class="k">def</span> <span class="nf">assignCardNames</span><span class="p">(</span><span class="n">excelCards</span><span class="p">):</span> 
       
    <span class="n">streetNames</span> <span class="o">=</span> <span class="n">extractStreetNames</span><span class="p">(</span><span class="n">excelCards</span><span class="o">.</span><span class="n">iName</span><span class="p">)</span>
    <span class="n">excelCards</span><span class="o">.</span><span class="n">streetNames</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">cleanStreetNames</span><span class="p">(</span><span class="n">streetNames</span><span class="p">))</span>
    <span class="n">excelCards</span><span class="o">.</span><span class="n">iiName</span> <span class="o">=</span> <span class="s">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">excelCards</span><span class="o">.</span><span class="n">streetNames</span><span class="p">)</span>
    </div>
<div class="viewcode-block" id="mapIntersectionsByName"><a class="viewcode-back" href="../script_importExcelSignals.html#importExcelSignals.mapIntersectionsByName">[docs]</a><span class="k">def</span> <span class="nf">mapIntersectionsByName</span><span class="p">(</span><span class="n">network</span><span class="p">,</span> <span class="n">excelCards</span><span class="p">,</span> <span class="n">mappedExcelCard</span><span class="p">,</span> <span class="n">mappedNodes</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Map each excel card to a dynameq node</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c">## These sets are now created and called in the _main_ section </span>
    <span class="c">#mappedExcelCards = []</span>

    <span class="c">#mappedNodes = {}</span>
    <span class="c">#for sd in excelCards:</span>

    <span class="k">if</span> <span class="n">findNodeWithSameStreetNames</span><span class="p">(</span><span class="n">network</span><span class="p">,</span> <span class="n">excelCards</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="n">mappedNodes</span><span class="p">):</span>
        <span class="n">mappedExcelCard</span> <span class="o">=</span> <span class="n">excelCards</span>
        <span class="c">#dta.DtaLogger.info(&quot;Mapped %s to %d (%s)&quot; % (sd.fileName, sd.mappedNodeId, str(network.getNodeForId(sd.mappedNodeId).getStreetNames())))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dta</span><span class="o">.</span><span class="n">DtaLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Failed to map </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">excelCards</span><span class="o">.</span><span class="n">fileName</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="getPossibleLinkDirections"><a class="viewcode-back" href="../script_importExcelSignals.html#importExcelSignals.getPossibleLinkDirections">[docs]</a><span class="k">def</span> <span class="nf">getPossibleLinkDirections</span><span class="p">(</span><span class="n">link</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a two element tuple containing the possible directions of the link.</span>
<span class="sd">    Example (NB, WB)&quot;&quot;&quot;</span>

    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">orientation</span> <span class="o">=</span> <span class="n">link</span><span class="o">.</span><span class="n">getOrientation</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">orientation</span> <span class="o">&gt;=</span> <span class="mi">270</span> <span class="ow">or</span> <span class="n">orientation</span> <span class="o">&lt;</span> <span class="mi">90</span><span class="p">:</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;NB&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;SB&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">orientation</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">orientation</span> <span class="o">&lt;</span> <span class="mi">180</span><span class="p">:</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;EB&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;WB&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>                                                                                        
</div>
<div class="viewcode-block" id="convertSignalToDynameq"><a class="viewcode-back" href="../script_importExcelSignals.html#importExcelSignals.convertSignalToDynameq">[docs]</a><span class="k">def</span> <span class="nf">convertSignalToDynameq</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">card</span><span class="p">,</span> <span class="n">planInfo</span><span class="p">,</span> <span class="n">startTime</span><span class="p">,</span> <span class="n">endTime</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert the excel signal described by the card object to</span>
<span class="sd">    a Dynameq time plan and return it. The input planInfo</span>
<span class="sd">    object determines the time period of operation</span>
<span class="sd">    &quot;&quot;&quot;</span>
<span class="c">## Commented this out so that start and end time can be specified based on type of signal while plan start and end are matched to scenario start and end</span>
    <span class="c">#startTime, endTime = planInfo.getTimePeriod()</span>
    <span class="n">signalTiming</span> <span class="o">=</span> <span class="n">selectCSO</span><span class="p">(</span><span class="n">card</span><span class="p">,</span><span class="n">startTime</span><span class="p">,</span> <span class="n">endTime</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">signalTiming</span><span class="p">:</span>
        <span class="n">cso</span> <span class="o">=</span> <span class="n">signalTiming</span><span class="o">.</span><span class="n">cso</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">signalTiming</span><span class="p">:</span>
        <span class="n">cso</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">cso</span><span class="p">:</span>
        <span class="n">startTime</span> <span class="o">=</span> <span class="n">dta</span><span class="o">.</span><span class="n">Time</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">endTime</span> <span class="o">=</span> <span class="n">dta</span><span class="o">.</span><span class="n">Time</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">signalTiming</span> <span class="o">=</span> <span class="n">selectCSO</span><span class="p">(</span><span class="n">card</span><span class="p">,</span><span class="n">startTime</span><span class="p">,</span> <span class="n">endTime</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">signalTiming</span><span class="p">:</span>
            <span class="n">cso</span> <span class="o">=</span> <span class="n">signalTiming</span><span class="o">.</span><span class="n">cso</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">signalTiming</span><span class="p">:</span>
            <span class="n">cso</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cso</span><span class="p">:</span>
            <span class="n">dta</span><span class="o">.</span><span class="n">DtaLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Unable to find CSO for signal </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">card</span><span class="o">.</span><span class="n">fileName</span><span class="p">)</span> 
            <span class="k">raise</span> <span class="n">dta</span><span class="o">.</span><span class="n">DtaError</span><span class="p">(</span><span class="s">&quot;Unable to find CSO for signal </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">card</span><span class="o">.</span><span class="n">fileName</span><span class="p">)</span>
    <span class="n">dta</span><span class="o">.</span><span class="n">DtaLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Signal </span><span class="si">%s</span><span class="s"> selected CSO </span><span class="si">%s</span><span class="s"> with start time </span><span class="si">%s</span><span class="s"> and end time </span><span class="si">%s</span><span class="s">.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">card</span><span class="o">.</span><span class="n">fileName</span><span class="p">,</span> <span class="n">cso</span><span class="p">,</span> <span class="n">signalTiming</span><span class="o">.</span><span class="n">startTime</span><span class="p">,</span> <span class="n">signalTiming</span><span class="o">.</span><span class="n">endTime</span><span class="p">))</span>
    <span class="n">offset</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">signalTiming</span><span class="p">[</span><span class="n">cso</span><span class="p">]</span><span class="o">.</span><span class="n">offset</span>
    <span class="n">dPlan</span> <span class="o">=</span> <span class="n">TimePlan</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">planInfo</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">startTime</span><span class="o">==</span><span class="n">dta</span><span class="o">.</span><span class="n">Time</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="n">endTime</span> <span class="o">==</span> <span class="n">dta</span><span class="o">.</span><span class="n">Time</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">excelPhases</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">getPhases</span><span class="p">(</span><span class="n">startTime</span><span class="p">,</span><span class="n">endTime</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c">#startTime, endTime= planInfo.getTimePeriod()</span>
        <span class="n">excelPhases</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">getPhases</span><span class="p">(</span><span class="n">startTime</span><span class="p">,</span> <span class="n">endTime</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">excelPhase</span> <span class="ow">in</span> <span class="n">excelPhases</span><span class="p">:</span>

        <span class="n">groupMovemenents</span> <span class="o">=</span> <span class="n">excelPhase</span><span class="p">[</span><span class="s">&quot;Movs&quot;</span><span class="p">]</span>
        <span class="n">green</span> <span class="o">=</span> <span class="n">excelPhase</span><span class="p">[</span><span class="s">&quot;green&quot;</span><span class="p">]</span>
        <span class="n">yellow</span> <span class="o">=</span> <span class="n">excelPhase</span><span class="p">[</span><span class="s">&quot;yellow&quot;</span><span class="p">]</span>
        <span class="n">red</span> <span class="o">=</span> <span class="n">excelPhase</span><span class="p">[</span><span class="s">&quot;allRed&quot;</span><span class="p">]</span>

        <span class="n">dPhase</span> <span class="o">=</span> <span class="n">Phase</span><span class="p">(</span><span class="n">dPlan</span><span class="p">,</span> <span class="n">green</span><span class="p">,</span> <span class="n">yellow</span><span class="p">,</span> <span class="n">red</span><span class="p">,</span> <span class="n">Phase</span><span class="o">.</span><span class="n">TYPE_STANDARD</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">groupMovement</span> <span class="ow">in</span> <span class="n">groupMovemenents</span><span class="p">:</span>
            <span class="n">dMovsAsStr</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">mappedMovements</span><span class="p">[</span><span class="n">groupMovement</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">dMovStr</span> <span class="ow">in</span> <span class="n">dMovsAsStr</span><span class="p">:</span>
                <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">n3</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">dMovStr</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
                <span class="n">dMov</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">getMovement</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span> <span class="n">n3</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">dMov</span><span class="o">.</span><span class="n">isProhibitedToAllVehicleClassGroups</span><span class="p">():</span>
                    <span class="k">continue</span>
                
                <span class="c">#Warn about turning movements that have dedicated signal phases.  These are designated as PROTECTED below.</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">dMov</span><span class="o">.</span><span class="n">getTurnType</span><span class="p">()</span> <span class="ow">in</span> <span class="n">groupMovementToTurnType</span><span class="p">(</span><span class="n">groupMovement</span><span class="p">,</span><span class="n">addRightToThru</span><span class="o">=</span><span class="bp">False</span><span class="p">)):</span>
                    <span class="n">dta</span><span class="o">.</span><span class="n">DtaLogger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;PERMITTED should be PROTECTED? groupMovement=</span><span class="si">%s</span><span class="s"> turntype=</span><span class="si">%s</span><span class="s">,  dMov=[</span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">] to [</span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">] turntype=</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> \
                                       <span class="p">(</span><span class="n">groupMovement</span><span class="p">,</span> <span class="n">groupMovementToTurnType</span><span class="p">(</span><span class="n">groupMovement</span><span class="p">),</span> 
                                        <span class="n">dMov</span><span class="o">.</span><span class="n">getIncomingLink</span><span class="p">()</span><span class="o">.</span><span class="n">getLabel</span><span class="p">(),</span> 
                                        <span class="n">dMov</span><span class="o">.</span><span class="n">getIncomingLink</span><span class="p">()</span><span class="o">.</span><span class="n">getDirection</span><span class="p">(),</span>
                                        <span class="n">dMov</span><span class="o">.</span><span class="n">getOutgoingLink</span><span class="p">()</span><span class="o">.</span><span class="n">getLabel</span><span class="p">(),</span>
                                        <span class="n">dMov</span><span class="o">.</span><span class="n">getOutgoingLink</span><span class="p">()</span><span class="o">.</span><span class="n">getDirection</span><span class="p">(),</span> 
                                        <span class="n">dMov</span><span class="o">.</span><span class="n">getTurnType</span><span class="p">()))</span>
                
                <span class="c">#Set through movements to be protected</span>
                <span class="k">if</span> <span class="n">dMov</span><span class="o">.</span><span class="n">isThruTurn</span><span class="p">():</span>
                    <span class="n">phaseMovement</span> <span class="o">=</span> <span class="n">PhaseMovement</span><span class="p">(</span><span class="n">dMov</span><span class="p">,</span> <span class="n">PhaseMovement</span><span class="o">.</span><span class="n">PROTECTED</span><span class="p">)</span>
                <span class="c">#Set turn movements to be protected if there is a dedicated signal phase</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">dMov</span><span class="o">.</span><span class="n">getTurnType</span><span class="p">()</span> <span class="ow">in</span> <span class="n">groupMovementToTurnType</span><span class="p">(</span><span class="n">groupMovement</span><span class="p">,</span><span class="n">addRightToThru</span><span class="o">=</span><span class="bp">False</span><span class="p">)):</span>
                    <span class="n">phaseMovement</span> <span class="o">=</span> <span class="n">PhaseMovement</span><span class="p">(</span><span class="n">dMov</span><span class="p">,</span> <span class="n">PhaseMovement</span><span class="o">.</span><span class="n">PROTECTED</span><span class="p">)</span>
                <span class="c">#Set all other movements to be permitted</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">phaseMovement</span> <span class="o">=</span> <span class="n">PhaseMovement</span><span class="p">(</span><span class="n">dMov</span><span class="p">,</span> <span class="n">PhaseMovement</span><span class="o">.</span><span class="n">PERMITTED</span><span class="p">)</span>
                <span class="c">##TODO: Figure out which turn movements are protected from both other traffic AND conflicting pedestrians/cyclists (i.e. pedestrian scrambles and turn arrows)</span>
                
                <span class="k">if</span> <span class="ow">not</span> <span class="n">dPhase</span><span class="o">.</span><span class="n">hasPhaseMovement</span><span class="p">(</span><span class="n">phaseMovement</span><span class="o">.</span><span class="n">getMovement</span><span class="p">()</span><span class="o">.</span><span class="n">getStartNodeId</span><span class="p">(),</span>
                                               <span class="n">phaseMovement</span><span class="o">.</span><span class="n">getMovement</span><span class="p">()</span><span class="o">.</span><span class="n">getEndNodeId</span><span class="p">()):</span>                    
                    <span class="n">dPhase</span><span class="o">.</span><span class="n">addPhaseMovement</span><span class="p">(</span><span class="n">phaseMovement</span><span class="p">)</span>
                
                <span class="c"># overrides</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">dMov</span><span class="o">.</span><span class="n">getIncomingLink</span><span class="p">()</span><span class="o">.</span><span class="n">getLabel</span><span class="p">()</span><span class="o">==</span><span class="s">&quot;SAN ANSELMO AVE&quot;</span> <span class="ow">and</span> <span class="n">dMov</span><span class="o">.</span><span class="n">getIncomingLink</span><span class="p">()</span><span class="o">.</span><span class="n">hasDirection</span><span class="p">(</span><span class="n">dta</span><span class="o">.</span><span class="n">RoadLink</span><span class="o">.</span><span class="n">DIR_WB</span><span class="p">)</span> <span class="ow">and</span>
                    <span class="n">dMov</span><span class="o">.</span><span class="n">getOutgoingLink</span><span class="p">()</span><span class="o">.</span><span class="n">getLabel</span><span class="p">()</span><span class="o">==</span><span class="s">&quot;PORTOLA DR&quot;</span>      <span class="ow">and</span> <span class="n">dMov</span><span class="o">.</span><span class="n">getOutgoingLink</span><span class="p">()</span><span class="o">.</span><span class="n">hasDirection</span><span class="p">(</span><span class="n">dta</span><span class="o">.</span><span class="n">RoadLink</span><span class="o">.</span><span class="n">DIR_WB</span><span class="p">)):</span>
                    <span class="n">dPhase</span><span class="o">.</span><span class="n">addPhaseMovement</span><span class="p">(</span><span class="n">PhaseMovement</span><span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">findMovementForRoadLabels</span><span class="p">(</span><span class="s">&quot;SANTA ANA AVE&quot;</span><span class="p">,</span> <span class="n">dta</span><span class="o">.</span><span class="n">RoadLink</span><span class="o">.</span><span class="n">DIR_NB</span><span class="p">,</span>
                                                                                        <span class="s">&quot;PORTOLA DR&quot;</span><span class="p">,</span>    <span class="n">dta</span><span class="o">.</span><span class="n">RoadLink</span><span class="o">.</span><span class="n">DIR_WB</span><span class="p">,</span>
                                                                                        <span class="s">&quot;PORTOLA DR&quot;</span><span class="p">,</span>
                                                                                        <span class="n">use_dir_for_movement</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span> <span class="n">PhaseMovement</span><span class="o">.</span><span class="n">PERMITTED</span><span class="p">))</span>
                    <span class="n">dPhase</span><span class="o">.</span><span class="n">addPhaseMovement</span><span class="p">(</span><span class="n">PhaseMovement</span><span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">findMovementForRoadLabels</span><span class="p">(</span><span class="s">&quot;SANTA ANA AVE&quot;</span><span class="p">,</span> <span class="n">dta</span><span class="o">.</span><span class="n">RoadLink</span><span class="o">.</span><span class="n">DIR_NB</span><span class="p">,</span>
                                                                                        <span class="s">&quot;14TH AVE&quot;</span><span class="p">,</span>      <span class="n">dta</span><span class="o">.</span><span class="n">RoadLink</span><span class="o">.</span><span class="n">DIR_WB</span><span class="p">,</span>
                                                                                        <span class="s">&quot;PORTOLA DR&quot;</span><span class="p">,</span>
                                                                                        <span class="n">use_dir_for_movement</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span> <span class="n">PhaseMovement</span><span class="o">.</span><span class="n">PERMITTED</span><span class="p">))</span>

        <span class="n">dPlan</span><span class="o">.</span><span class="n">addPhase</span><span class="p">(</span><span class="n">dPhase</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">dPlan</span>
    </div>
<div class="viewcode-block" id="manuallyDetermineMappedNodeId"><a class="viewcode-back" href="../script_importExcelSignals.html#importExcelSignals.manuallyDetermineMappedNodeId">[docs]</a><span class="k">def</span> <span class="nf">manuallyDetermineMappedNodeId</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">cardsDirectory</span><span class="p">,</span> <span class="n">manuallyMappedIntersectionsFile</span><span class="p">):</span>

    <span class="n">fileNames</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">cardsDirectory</span><span class="p">)</span>
    
    <span class="n">cards</span> <span class="o">=</span> <span class="n">parseExcelCardsToSignalObjects</span><span class="p">(</span><span class="n">cardsDirectory</span><span class="p">)</span>
    <span class="n">assignCardNames</span><span class="p">(</span><span class="n">cards</span><span class="p">)</span>
    <span class="n">cardsByName</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">card</span> <span class="ow">in</span> <span class="n">cards</span><span class="p">:</span>
        <span class="n">cardsByName</span><span class="p">[</span><span class="n">card</span><span class="o">.</span><span class="n">fileName</span><span class="p">]</span> <span class="o">=</span> <span class="n">card</span>

    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictReader</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">manuallyMappedIntersectionsFile</span><span class="p">,</span> <span class="s">&quot;r&quot;</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">record</span><span class="p">[</span><span class="s">&quot;status&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;2&quot;</span><span class="p">:</span>
            <span class="n">nodeId</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="s">&quot;manualCubeNode&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">nodeId</span><span class="p">:</span>
                <span class="n">id_</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">nodeId</span><span class="p">)</span> 
                <span class="k">if</span> <span class="n">net</span><span class="o">.</span><span class="n">hasNodeForId</span><span class="p">(</span><span class="n">id_</span><span class="p">):</span>
                    <span class="n">cardsByName</span><span class="p">[</span><span class="n">record</span><span class="p">[</span><span class="s">&quot;fileName&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">mappedNodeId</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">nodeId</span><span class="p">)</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cardsByName</span><span class="p">[</span><span class="n">record</span><span class="p">[</span><span class="s">&quot;fileName&quot;</span><span class="p">]])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">print</span> <span class="s">&quot;File &quot;</span><span class="p">,</span> <span class="n">record</span><span class="p">[</span><span class="s">&quot;fileName&quot;</span><span class="p">],</span> <span class="s">&quot; does has been mapped to an non-existing node&quot;</span><span class="p">,</span> <span class="n">id_</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&quot;File &quot;</span><span class="p">,</span> <span class="n">record</span><span class="p">[</span><span class="s">&quot;fileName&quot;</span><span class="p">],</span> <span class="s">&quot; does not have a mapped node id&quot;</span>

    <span class="k">return</span> <span class="n">result</span> 
</div>
<div class="viewcode-block" id="getMappedCards"><a class="viewcode-back" href="../script_importExcelSignals.html#importExcelSignals.getMappedCards">[docs]</a><span class="k">def</span> <span class="nf">getMappedCards</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">excelCards</span><span class="p">,</span> <span class="n">mappedExcelCard</span><span class="p">,</span> <span class="n">mappedNodes</span><span class="p">,</span> <span class="n">cardsDirectoryManuallyMapped</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span> 
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read the cards in the cards directory and map them to network nodes.</span>
<span class="sd">    Return the mapped signal objects cards in a list </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">## This is not needed anymore.  The parsed excel card is passed to the function as an argument.</span>
    <span class="c">#excelCards = parseExcelCardsToSignalObjects(cardsDirectory)</span>

    <span class="n">cards</span> <span class="o">=</span> <span class="n">excelCards</span>
    <span class="n">assignCardNames</span><span class="p">(</span><span class="n">cards</span><span class="p">)</span>
    <span class="n">mapIntersectionsByName</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">cards</span><span class="p">,</span> <span class="n">mappedExcelCard</span><span class="p">,</span> <span class="n">mappedNodes</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">cardsDirectoryManuallyMapped</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;We should not have any manually mapped nodes&quot;</span><span class="p">)</span> 
    <span class="k">if</span> <span class="n">cardsDirectoryManuallyMapped</span><span class="p">:</span>
        <span class="n">cards2</span> <span class="o">=</span> <span class="n">manuallyDetermineMappedNodeId</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">cardsDirectoryManuallyMapped</span><span class="p">)</span>
        <span class="n">assignCardNames</span><span class="p">(</span><span class="n">cards2</span><span class="p">)</span>     
        <span class="n">cards3</span> <span class="o">=</span> <span class="n">mapStreetNamesForManuallyMappedNodes</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">cards2</span><span class="p">)</span>
        <span class="n">cards</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">cards3</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">cards</span> 
</div>
<div class="viewcode-block" id="exportToJSON"><a class="viewcode-back" href="../script_importExcelSignals.html#importExcelSignals.exportToJSON">[docs]</a><span class="k">def</span> <span class="nf">exportToJSON</span><span class="p">(</span><span class="n">cards</span><span class="p">,</span> <span class="n">outFileName</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Export the signal cards to json format</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">output</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&quot;outfileName.json&quot;</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">card</span> <span class="ow">in</span> <span class="n">cards</span><span class="p">:</span>
        <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">card</span><span class="o">.</span><span class="n">toDict</span><span class="p">(),</span><span class="n">separators</span><span class="o">=</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">,</span><span class="s">&#39;:&#39;</span><span class="p">),</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">))</span>
    <span class="n">output</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="createDynameqSignals"><a class="viewcode-back" href="../script_importExcelSignals.html#importExcelSignals.createDynameqSignals">[docs]</a><span class="k">def</span> <span class="nf">createDynameqSignals</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">card</span><span class="p">,</span> <span class="n">planInfo</span><span class="p">,</span><span class="n">startTime</span><span class="p">,</span> <span class="n">endTime</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a dynameq signal for each excel card object for</span>
<span class="sd">    the specified input period</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#for card in cardsWithMovements:</span>
    <span class="n">nodeId</span> <span class="o">=</span> <span class="n">card</span><span class="o">.</span><span class="n">mappedNodeId</span>
    <span class="n">node</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">getNodeForId</span><span class="p">(</span><span class="n">nodeId</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">dPlan</span> <span class="o">=</span> <span class="n">convertSignalToDynameq</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">card</span><span class="p">,</span> <span class="n">planInfo</span><span class="p">,</span> <span class="n">startTime</span><span class="p">,</span> <span class="n">endTime</span><span class="p">)</span>
        <span class="n">dPlan</span><span class="o">.</span><span class="n">setPermittedMovements</span><span class="p">()</span>            
        <span class="n">dPlan</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>
                        
    <span class="k">except</span> <span class="n">ExcelCardError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">dta</span><span class="o">.</span><span class="n">DtaLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Error 1: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="k">except</span> <span class="n">dta</span><span class="o">.</span><span class="n">DtaError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">dta</span><span class="o">.</span><span class="n">DtaLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Error 2: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">node</span><span class="o">.</span><span class="n">addTimePlan</span><span class="p">(</span><span class="n">dPlan</span><span class="p">,</span> <span class="n">raiseValidateError</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">dta</span><span class="o">.</span><span class="n">DtaError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">dta</span><span class="o">.</span><span class="n">DtaLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Error 3: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">False</span>

    <span class="c"># todo: remove these.  node.addTimePlan() set the control variable        </span>
    <span class="k">assert</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">_control</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">node</span><span class="o">.</span><span class="n">_control</span><span class="o">=</span><span class="mi">1</span>
    
    <span class="k">return</span> <span class="n">dPlan</span>
</div>
<div class="viewcode-block" id="verifySingleSignal"><a class="viewcode-back" href="../script_importExcelSignals.html#importExcelSignals.verifySingleSignal">[docs]</a><span class="k">def</span> <span class="nf">verifySingleSignal</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">fileName</span><span class="p">,</span> <span class="n">mappedNodes</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read the signal card stored in the fileName and verify that</span>
<span class="sd">    can be imported properly to the dynameq network provided as</span>
<span class="sd">    the first argument </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">directory</span><span class="p">,</span> <span class="n">fn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
    <span class="n">sd</span> <span class="o">=</span> <span class="n">parseExcelCardFile</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">fn</span><span class="p">)</span>
    <span class="n">cards</span> <span class="o">=</span> <span class="p">[</span><span class="n">sd</span><span class="p">]</span>
    <span class="n">assignCardNames</span><span class="p">(</span><span class="n">cards</span><span class="p">)</span>
    <span class="n">mapIntersectionsByName</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">cards</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">sd</span><span class="o">.</span><span class="n">mappedNodeId</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&quot;The card was not mapped to a Cube node&quot;</span> 
    <span class="k">else</span><span class="p">:</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">getNodeForId</span><span class="p">(</span><span class="n">sd</span><span class="o">.</span><span class="n">mappedNodeId</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">&quot;</span><span class="si">%20s</span><span class="s">,</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&quot;Cube int name&quot;</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">getStreetNames</span><span class="p">())</span>
        <span class="k">print</span> <span class="s">&quot;</span><span class="si">%20s</span><span class="s">,</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&quot;Excel card name&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">sd</span><span class="o">.</span><span class="n">streetNames</span><span class="p">))</span>
        <span class="n">mapMovements</span><span class="p">(</span><span class="n">cards</span><span class="p">,</span> <span class="n">net</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">movDir</span><span class="p">,</span> <span class="n">nodeTriplets</span> <span class="ow">in</span> <span class="n">sd</span><span class="o">.</span><span class="n">mappedMovements</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="k">print</span> <span class="n">movDir</span>            
            <span class="k">for</span> <span class="n">nodeTriplet</span> <span class="ow">in</span> <span class="n">nodeTriplets</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&quot;</span><span class="se">\t\t</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">nodeTriplet</span>
</div>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&quot;__main__&quot;</span><span class="p">:</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">:</span>
        <span class="k">print</span> <span class="n">USAGE</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">INPUT_DYNAMEQ_NET_DIR</span>         <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">INPUT_DYNAMEQ_NET_PREFIX</span>      <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">EXCEL_DIR</span>                     <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">START_TIME</span>                    <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
    <span class="n">END_TIME</span>                      <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">7</span><span class="p">:</span>
        <span class="n">MOVEMENT_TURN_OVERRIDES</span>   <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">6</span><span class="p">:]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">MOVEMENT_TURN_OVERRIDES</span>   <span class="o">=</span> <span class="bp">None</span>
    <span class="c">#OUTPUT_DYNAMEQ_NET_DIR        = sys.argv[6]</span>
    <span class="c">#OUTPUT_DYNAMEQ_NET_PREFIX     = sys.argv[7]</span>

    <span class="c"># The SanFrancisco network will use feet for vehicle lengths and coordinates, and miles for link lengths</span>
    <span class="n">dta</span><span class="o">.</span><span class="n">VehicleType</span><span class="o">.</span><span class="n">LENGTH_UNITS</span><span class="o">=</span> <span class="s">&quot;feet&quot;</span>
    <span class="n">dta</span><span class="o">.</span><span class="n">Node</span><span class="o">.</span><span class="n">COORDINATE_UNITS</span>   <span class="o">=</span> <span class="s">&quot;feet&quot;</span>
    <span class="n">dta</span><span class="o">.</span><span class="n">RoadLink</span><span class="o">.</span><span class="n">LENGTH_UNITS</span>   <span class="o">=</span> <span class="s">&quot;miles&quot;</span>

    <span class="n">dta</span><span class="o">.</span><span class="n">setupLogging</span><span class="p">(</span><span class="s">&quot;importExcelSignals.INFO.log&quot;</span><span class="p">,</span> <span class="s">&quot;importExcelSignals.DEBUG.log&quot;</span><span class="p">,</span> <span class="n">logToConsole</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">scenario</span> <span class="o">=</span> <span class="n">dta</span><span class="o">.</span><span class="n">DynameqScenario</span><span class="p">()</span>
    <span class="n">scenario</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">INPUT_DYNAMEQ_NET_DIR</span><span class="p">,</span> <span class="n">INPUT_DYNAMEQ_NET_PREFIX</span><span class="p">)</span> 
    <span class="n">net</span> <span class="o">=</span> <span class="n">dta</span><span class="o">.</span><span class="n">DynameqNetwork</span><span class="p">(</span><span class="n">scenario</span><span class="p">)</span>
    <span class="n">net</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">INPUT_DYNAMEQ_NET_DIR</span><span class="p">,</span> <span class="n">INPUT_DYNAMEQ_NET_PREFIX</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">MOVEMENT_TURN_OVERRIDES</span><span class="p">:</span>
        <span class="n">overrides</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">override_file</span> <span class="ow">in</span> <span class="n">MOVEMENT_TURN_OVERRIDES</span><span class="p">:</span>
            <span class="n">inputstream</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">override_file</span><span class="p">,</span> <span class="s">&quot;r&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">inputstream</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
                <span class="n">override</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;,&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">override</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;From Dir&quot;</span><span class="p">:</span> <span class="k">continue</span> <span class="c"># header line</span>
                <span class="k">if</span> <span class="n">override</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;Thru&#39;</span><span class="p">:</span> <span class="n">override</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">dta</span><span class="o">.</span><span class="n">Movement</span><span class="o">.</span><span class="n">DIR_TH</span>
                <span class="n">overrides</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">override</span><span class="p">)</span>
        <span class="n">net</span><span class="o">.</span><span class="n">setMovementTurnTypeOverrides</span><span class="p">(</span><span class="n">overrides</span><span class="p">)</span>


    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">net</span><span class="o">.</span><span class="n">iterRoadNodes</span><span class="p">():</span>
        <span class="n">node</span><span class="o">.</span><span class="n">_control</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c">## This section was testing the pickle module, but it&#39;s not used anymore.      </span>
<span class="c">##    in2 = open(&quot;test.pkl&quot;, &quot;rb&quot;)</span>
<span class="c">##    data2 = pickle.load(in2)</span>
<span class="c">##    in2.close()    </span>

<span class="c">##    for i in range(len(excelCards)):</span>
<span class="c">##        excelCards[i].mappedStreet = data2[i][0]</span>
<span class="c">##        excelCards[i].mappedNodeName = data2[i][1]</span>
<span class="c">##        excelCards[i].mappedNodeId = data2[i][2]</span>
    <span class="n">problemCards</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">cardsDone</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">mappedNodes</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">cardsWithMove</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">allPlansSet</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">allMoreMatchesSet</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">nummatches</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">planInfo</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">addPlanCollectionInfo</span><span class="p">(</span><span class="n">dta</span><span class="o">.</span><span class="n">Time</span><span class="o">.</span><span class="n">readFromString</span><span class="p">(</span><span class="n">scenario</span><span class="o">.</span><span class="n">startTime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%H:%M&quot;</span><span class="p">)),</span> <span class="n">dta</span><span class="o">.</span><span class="n">Time</span><span class="o">.</span><span class="n">readFromString</span><span class="p">(</span><span class="n">scenario</span><span class="o">.</span><span class="n">endTime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%H:%M&quot;</span><span class="p">)),</span> <span class="s">&quot;excelSignalsToDynameq&quot;</span><span class="p">,</span> <span class="s">&quot;excel_signal_cards_imported_automatically&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">fileName</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">EXCEL_DIR</span><span class="p">):</span>
        <span class="n">excelCards</span> <span class="o">=</span> <span class="n">parseExcelCardsToSignalObjects</span><span class="p">(</span><span class="n">EXCEL_DIR</span><span class="p">,</span><span class="n">fileName</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">excelCards</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cardsDone</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">excelCards</span><span class="p">)</span>
        <span class="n">assignCardNames</span><span class="p">(</span><span class="n">excelCards</span><span class="p">)</span>
        
        <span class="n">cards</span> <span class="o">=</span> <span class="n">excelCards</span>
        <span class="n">mappedExcelCard</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cards</span> <span class="o">=</span> <span class="n">getMappedCards</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">excelCards</span><span class="p">,</span> <span class="n">mappedExcelCard</span><span class="p">,</span> <span class="n">mappedNodes</span><span class="p">)</span> 
    
        <span class="n">cardsWithMovements</span> <span class="o">=</span> <span class="n">mapMovements</span><span class="p">(</span><span class="n">cards</span><span class="p">,</span> <span class="n">net</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cardsWithMovements</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cardsWithMove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cardsWithMovements</span><span class="p">)</span>           
        <span class="n">allPlans</span> <span class="o">=</span> <span class="n">createDynameqSignals</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">cardsWithMovements</span><span class="p">,</span> <span class="n">planInfo</span><span class="p">,</span> <span class="n">dta</span><span class="o">.</span><span class="n">Time</span><span class="o">.</span><span class="n">readFromString</span><span class="p">(</span><span class="n">START_TIME</span><span class="p">),</span> <span class="n">dta</span><span class="o">.</span><span class="n">Time</span><span class="o">.</span><span class="n">readFromString</span><span class="p">(</span><span class="n">END_TIME</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">allPlans</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">allPlansSet</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">allPlans</span><span class="p">)</span>
        <span class="c">## This section is used to check for cards that have multiple CSOs matching the start and and time.  This allows us to identify</span>
        <span class="c">## cards that have both weekend and weekday time plans so that we know which ones need fixed.</span>
        <span class="n">nummatches</span> <span class="o">=</span> <span class="n">checkNumberofTimes</span><span class="p">(</span><span class="n">cardsWithMovements</span><span class="p">,</span> <span class="n">dta</span><span class="o">.</span><span class="n">Time</span><span class="o">.</span><span class="n">readFromString</span><span class="p">(</span><span class="n">START_TIME</span><span class="p">),</span> <span class="n">dta</span><span class="o">.</span><span class="n">Time</span><span class="o">.</span><span class="n">readFromString</span><span class="p">(</span><span class="n">END_TIME</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">nummatches</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">allMoreMatchesSet</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
            <span class="n">dta</span><span class="o">.</span><span class="n">DtaLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Signal </span><span class="si">%s</span><span class="s"> has </span><span class="si">%d</span><span class="s"> phases matching the start and end time&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fileName</span><span class="p">,</span> <span class="n">nummatches</span><span class="p">))</span>

    <span class="n">dta</span><span class="o">.</span><span class="n">DtaLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Number of excel cards successfully parsed = </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">cardsDone</span><span class="p">))</span>
    <span class="n">dta</span><span class="o">.</span><span class="n">DtaLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Number of cards are </span><span class="si">%d</span><span class="s">; Number of mapped nodes are </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cardsDone</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">mappedNodes</span><span class="p">)))</span>
    <span class="n">dta</span><span class="o">.</span><span class="n">DtaLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Number of cards are </span><span class="si">%d</span><span class="s">; Number of cards with movements are </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cardsDone</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">cardsWithMove</span><span class="p">)))</span>
    <span class="n">dta</span><span class="o">.</span><span class="n">DtaLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Number of time plans = </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">allPlansSet</span><span class="p">))</span>
    <span class="n">dta</span><span class="o">.</span><span class="n">DtaLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Number of excel cards with multiple times matching start and end time = </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">allMoreMatchesSet</span><span class="p">))</span>

    <span class="c">#Adjust Followup time for signalized right and left turning movements </span>
    <span class="n">rightTurnFollowupLookup</span> <span class="o">=</span> <span class="p">{</span><span class="mi">90</span><span class="p">:</span><span class="mf">2.67</span><span class="p">,</span> <span class="mi">91</span><span class="p">:</span><span class="mf">2.22</span><span class="p">,</span> <span class="mi">92</span><span class="p">:</span><span class="mf">2.0</span><span class="p">,</span> <span class="mi">93</span><span class="p">:</span><span class="mf">2.0</span><span class="p">,</span> <span class="mi">94</span><span class="p">:</span><span class="mf">2.0</span><span class="p">,</span> <span class="mi">95</span><span class="p">:</span><span class="mf">2.0</span><span class="p">,}</span>
    <span class="n">leftTurnFollowupLookup</span>  <span class="o">=</span> <span class="p">{</span><span class="mi">90</span><span class="p">:</span><span class="mf">2.67</span><span class="p">,</span> <span class="mi">91</span><span class="p">:</span><span class="mf">2.22</span><span class="p">,</span> <span class="mi">92</span><span class="p">:</span><span class="mf">2.0</span><span class="p">,</span> <span class="mi">93</span><span class="p">:</span><span class="mf">2.0</span><span class="p">,</span> <span class="mi">94</span><span class="p">:</span><span class="mf">2.0</span><span class="p">,</span> <span class="mi">95</span><span class="p">:</span><span class="mf">2.0</span><span class="p">,}</span> 
    
    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">net</span><span class="o">.</span><span class="n">iterRoadNodes</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">mov</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">iterMovements</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">node</span><span class="o">.</span><span class="n">hasTimePlan</span><span class="p">():</span>
                <span class="n">mov</span><span class="o">.</span><span class="n">setFollowup</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">mov</span><span class="o">.</span><span class="n">isRightTurn</span><span class="p">():</span>
                <span class="n">mov</span><span class="o">.</span><span class="n">setFollowup</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">rightTurnFollowupLookup</span><span class="p">[</span><span class="n">mov</span><span class="o">.</span><span class="n">getFollowup</span><span class="p">()]))</span>
            <span class="k">elif</span> <span class="n">mov</span><span class="o">.</span><span class="n">isLeftTurn</span><span class="p">():</span>
                <span class="n">mov</span><span class="o">.</span><span class="n">setFollowup</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">leftTurnFollowupLookup</span><span class="p">[</span><span class="n">mov</span><span class="o">.</span><span class="n">getFollowup</span><span class="p">()]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mov</span><span class="o">.</span><span class="n">setFollowup</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">net</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">,</span> <span class="s">&quot;sf_signals&quot;</span><span class="p">)</span>

    <span class="c">#net.writeLinksToShp(&quot;sf_signals_link&quot;)</span>
    <span class="c">#net.writeNodesToShp(&quot;sf_signals_node&quot;)    </span>
    
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../index.html">DTA Anyway 1.0 documentation</a> &raquo;</li>
          <li><a href="index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2011-2012, SFCTA Modeling Crew.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>